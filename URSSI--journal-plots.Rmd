---
title: "URSSI Analysis"
author: "Jessica Young and Karthik Ram"
output:
  html_document:
    toc: true
    toc_levels: 1
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

pacman::p_load(
  dplyr,
  ggplot2,
  stringr,
  reshape2,
  flextable,
  DT,
  VIM,
  gplots,
  RColorBrewer,
  corrplot,
  knitr,
  gridExtra,
  grid,
  gridGraphics,
  # SparseDC,
  broom,
  irr,
  listviewer,
  formattable,
  sp,
  maps,
  maptools,
  revgeo,
  mapproj,
  emmeans
)

library(ggthemr)
# Random colours that aren't white.
# set.seed(12345)
# random_colours <-
#   c(
#     "#03071e",
#     "#370617",
#     "#6a040f",
#     "#9d0208",
#     "#d00000",
#     "#dc2f02",
#     "#e85d04",
#     "#f48c06",
#     "#faa307",
#     "#ffba08"
#   )
# 
# ugly <- define_palette(
#   swatch = random_colours,
#   gradient = c(lower = random_colours[1L], upper = random_colours[2L])
# )
# 
# ggthemr(ugly)

ggthemr("fresh")

dat = read.csv("urssi_survey_data_2019_12_24.csv", stringsAsFactors = F)[-c(1:2), -c(1:3, 6, 8:13, 16:17)]

rownames(dat) = read.csv("urssi_survey_data_2019_12_24.csv", stringsAsFactors = F)[-c(1:2), 9]

info_cols = as.character(read.csv("urssi_survey_data_2019_12_24.csv", stringsAsFactors = F)[1, -c(1:3, 6, 8:13, 16:17)])

dat$Progress = as.numeric(as.character(dat$Progress))

dat_na = as.data.frame(apply(dat, 2, function(x)
  ifelse(x == "", NA, x)), stringsAsFactors = F)

source("functions.R")
```

# Completion Rate

```{r cache = TRUE}
cat("There are",
    table(dat$Finished)[2],
    "Qualtrics surveys marked finished.")
cat("There are",
    table(dat$Finished)[1],
    "Qualtrics surveys marked not finished.")
#table(dat$Finished)

cat(
  "There were a total of",
  length(dat$Progress) ,
  "participants. \n",
  sum(dat$Finished == 'False'),
  "participants,",
  round(sum(dat$Finished == 'False') / length(dat$Finished) * 100, 2),
  "% of participants, did not finish the survey."
)

hist(dat$Progress,
     xlab = 'Progress',
     main = 'Distribution of Qualtrics Recorded Survey Progress')
```



# Which profile matches the work you perform?

```{r Q1, cache=TRUE}

ggplot(dat_na, aes(x = Q1.1, fill = Finished)) +
  geom_bar(position = "dodge") +
  labs(x = 'Profile', y = 'Frequency') +
  scale_fill_discrete(labels = c("Unfinished", "Finished"),
                      breaks = c("False", "True"))

tmp = dat_na %>%
  group_by(Q1.1) %>%
  tally()
```

```{r cache = TRUE}
dat_na %>%
  group_by(Q1.1, Finished) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x / n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1),
                 part = "body") %>%
  fix_border_issues()

```

# Demographics

## What type of organization do you work for?

```{r Q2_2, cache=TRUE}

dat_na$Q2.2_4_TEXT = with(dat_na,
    ifelse(Q2.2_4_TEXT=="Non-profit research org"|Q2.2_4_TEXT=="Non profit research"|Q2.2_4_TEXT=="Nonprofit"|
             Q2.2_4_TEXT=="non-profit edTech R&D"|Q2.2_4_TEXT=="Non-profit research center, but not a national lab"|
             Q2.2_4_TEXT=="NSF-funded non-profit"|Q2.2_4_TEXT=="Non-profit research lab"|Q2.2_4_TEXT=="not for profit research institute"|
             Q2.2_4_TEXT=="non-profit research institute"|Q2.2_4_TEXT=="nonprofit lab"|Q2.2_4_TEXT=="Not for profit"|Q2.2_4_TEXT=="nonprofit research org"|
             Q2.2_4_TEXT=="Private non profit research institute"|Q2.2_4_TEXT=="Not for profit research"|Q2.2_4_TEXT=="non profit research institute"|
             Q2.2_4_TEXT=="Not-for-profit that does education development (curriculum, professional education) and research", "Non-profit",
    ifelse(Q2.2_4_TEXT=="retired"|Q2.2_4_TEXT=="retired professor.  I don't work for anyone, any more...", "Retired",
           ifelse(Q2.2_4_TEXT=="FFRDC"|Q2.2_4_TEXT=="Government"|Q2.2_4_TEXT=="US Government"|Q2.2_4_TEXT=="DoD HCPMP", "Government",
                  ifelse(Q2.2_4_TEXT=="My own start-up"|Q2.2_4_TEXT=="small business"|Q2.2_4_TEXT=="Small business"|Q2.2_4_TEXT=="startup", "Small Business",
                         ifelse(Q2.2_4_TEXT=="Company and University"|Q2.2_4_TEXT=="I'm a student."|
                                    Q2.2_4_TEXT=="I did this work at a university then left for industy. I'm answering as if I were still at the University"|
                                    Q2.2_4_TEXT=="University and hospital"|Q2.2_4_TEXT=="both educational insitution and industry","Educational institution",
                                ifelse(Q2.2_4_TEXT=="Private laboratory"|Q2.2_4_TEXT=="acedemic service provider "|Q2.2_4_TEXT=="International lab"|
                                           Q2.2_4_TEXT=="research medical center"|Q2.2_4_TEXT=="Infrastructure institution"|
                                           Q2.2_4_TEXT=="University-based research collaboration"|Q2.2_4_TEXT=="private research institute"|
                                           Q2.2_4_TEXT=="International Organisation"|Q2.2_4_TEXT=="Research institute"|Q2.2_4_TEXT=="Cancer Research Center"|
                                           Q2.2_4_TEXT=="Scientific research center (academic/non-academic collaboration)"|
                                           Q2.2_4_TEXT=="Combo of research & commercial "|Q2.2_4_TEXT=="Professional society" ,"Research Center/Non-national Lab",Q2.2_4_TEXT)))))))

dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q2.2)) %>%
    select(Q1.1, Q2.2, Q2.2_4_TEXT)

ggplot(dat, aes(x = Q1.1, fill = Q2.2)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(legend.title = element_blank())

ggplot(dat, aes(x = Q1.1, fill = Q2.2)) +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(legend.title = element_blank())

tmp = dat %>%
  group_by(Q1.1) %>%
  tally()
```

```{r cache=TRUE}
dat %>%
  group_by(Q1.1, Q2.2) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 ) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q2_2_details, cache=TRUE}

dat %>%
  group_by(Q1.1, Q2.2_4_TEXT) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 ) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()


```


## US States

```{r Q2_3_states, cache=TRUE}
reg = unique(dat_na$Q2.3)


dat_na$Q2.3 = ifelse(dat_na$Q2.3=="United States of America", "USA",
                     ifelse(dat_na$Q2.3=="United Kingdom of Great Britain and Northern Ireland", "UK",
                            ifelse(dat_na$Q2.3==reg[5], "Iran",dat_na$Q2.3)))

dat_na$Continent = ifelse(dat_na$Q2.3=="USA"|dat_na$Q2.3=="Canada", "N.America",
                    ifelse(dat_na$Q2.3=="Turkey"|dat_na$Q2.3=="Iran"|dat_na$Q2.3=="China"|
                               dat_na$Q2.3=="India"|dat_na$Q2.3=="Japan"|dat_na$Q2.3=="South Korea", "Asia",
                     ifelse(dat_na$Q2.3=="Australia","Australia",
                      ifelse(dat_na$Q2.3=="Netherlands"|dat_na$Q2.3=="France"|
                                 dat_na$Q2.3=="Switzerland"|dat_na$Q2.3=="UK"|dat_na$Q2.3=="Germany"|
                                 dat_na$Q2.3=="Norway"|dat_na$Q2.3=="Romania"|dat_na$Q2.3=="Spain", "Europe",dat_na$Q2.3))))


dat = dat_na %>%
    filter(!is.na(Q1.1) & Q2.3=="USA" & !is.na(LocationLatitude) & !is.na(LocationLongitude)) %>%
    select(Q1.1, LocationLatitude, LocationLongitude) %>%
  mutate(LocationLongitude = as.numeric(LocationLongitude),
         LocationLatitude = as.numeric(LocationLatitude))

#x = revgeo(dat$LocationLongitude, dat$LocationLatitude, provider = "photon", output = 'frame', item = "state")

#dat$states = ifelse(as.character(x$country)=='United States of America', as.character(x$state), NA)

#datm = dat %>%
#  select(states) %>%
#  group_by(states) %>%
#    tally() %>%
#  filter(!is.na(states)) %>%
#  mutate(states= tolower(states))

states_map <- map_data("state")

#tmp = left_join(states, datm, by=c("region" = 'states'))

#save(tmp, file = 'regeo_results.rda')
#save(datm, file ="datm.rda")
load('regeo_results.rda')
load('datm.rda')

#ggplot(tmp, aes(long, lat)) +
#  geom_polygon(aes(group = group, fill = n),  colour = "black") +
#  scale_fill_gradient2(low = "#559999", mid = "grey90", high = "#BB650B",
#                       midpoint = median(tmp$n, na.rm = T)) +
#  coord_map("albers",  at0 = 45.5, lat1 = 29.5) +
#  theme_void() + 
#  labs(fill = "Frequency") +
#  ggtitle('Respondents per State')

colnames(datm) = c("state", "n")

ggplot(datm, aes(map_id = state, fill = n)) +
  geom_map(map = states_map, colour = "black") +
  scale_fill_gradient2(low = "#559999", mid = "grey90", high = "#BB650B",
                       midpoint = median(datm$n, na.rm = T)) +
  expand_limits(x = states_map$long, y = states_map$lat) +
  coord_map("albers",  at0 = 45.5, lat1 = 29.5) +
  theme_void() + 
  labs(fill = "Frequency") +
  ggtitle('Respondents per State')

```

```{r cache=TRUE}
datm %>%
  flextable() %>%
  autofit() %>%
  fix_border_issues()
```

```{r Q2_3map, cache=TRUE}
m = ggplot(tmp, aes(long, lat)) +
  geom_polygon(aes(group = group),  colour = "black", fill = NA) +
  coord_map("albers",  at0 = 45.5, lat1 = 29.5) +
  theme_void() + 
  ggtitle('Respondents per State')


m + geom_point(data = dat[dat$LocationLongitude<=-67.00742 & dat$LocationLatitude<=49.38323 &
                          dat$LocationLatitude>=25.12993,],aes(x = LocationLongitude, y = LocationLatitude),
               colour = "red")

```

## List of Countries

```{r Q2_3, cache=TRUE}

reg = unique(dat_na$Q2.3)

dat_na$Q2.3 = ifelse(dat_na$Q2.3=="United States of America", "USA",
                     ifelse(dat_na$Q2.3=="United Kingdom of Great Britain and Northern Ireland", "UK",
                            ifelse(dat_na$Q2.3==reg[5], "Iran",dat_na$Q2.3)))

dat_na$Continent = ifelse(dat_na$Q2.3=="USA"|dat_na$Q2.3=="Canada", "N.America",
                    ifelse(dat_na$Q2.3=="Turkey"|dat_na$Q2.3=="Iran"|dat_na$Q2.3=="China"|
                               dat_na$Q2.3=="India"|dat_na$Q2.3=="Japan"|dat_na$Q2.3=="South Korea", "Asia",
                     ifelse(dat_na$Q2.3=="Australia","Australia",
                      ifelse(dat_na$Q2.3=="Netherlands"|dat_na$Q2.3=="France"|
                                 dat_na$Q2.3=="Switzerland"|dat_na$Q2.3=="UK"|dat_na$Q2.3=="Germany"|
                                 dat_na$Q2.3=="Norway"|dat_na$Q2.3=="Romania"|dat_na$Q2.3=="Spain", "Europe",dat_na$Q2.3))))

dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q2.3)) %>%
    select(Q1.1, Continent, Q2.3)
ggthemr('urssi_colors')

ggplot(dat, aes(x = Continent, fill = Q1.1)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())

ggthemr::ggthemr('urssi_colors')
ggplot(dat, aes(x = Continent, fill = Q1.1)) +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())


tmp = dat %>%
  group_by(Q1.1) %>%
  tally()
```

```{r cache=TRUE}
dat %>%
  group_by(Q1.1, Continent) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 ) %>%
  autofit() %>%
  fix_border_issues()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

### Countries Breakdown

```{r Q2_3_details, cache=TRUE}

obj = table(dat$Q2.3, dat$Q1.1)
print(obj)


tmp = dat %>%
   group_by(Q1.1) %>%
  tally()
```

```{r cache=TRUE}
dat %>%
  group_by(Q1.1, Q2.3) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 ) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```




## Job Titles

```{r Q2_4, cache=TRUE}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q2.4)) %>%
    select(Q1.1,Q2.4_8_TEXT, Q2.4)
ggthemr('urssi_colors')
ggplot(dat, aes(x = Q1.1, fill = Q2.4)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())

ggplot(dat, aes(x = Q1.1, fill = Q2.4)) +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())

```

```{r cache=TRUE}
dat %>%
  group_by(Q1.1, Q2.4) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 ) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

### Other Job Titles

```{r Q2_4_details, echo = F, message = F}

dat %>%
  group_by(Q1.1, Q2.4_8_TEXT) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 ) %>%
  autofit() %>%
  fix_border_issues() %>%
  hline(i = c(58,90), part = "body",
        border = officer::fp_border(color = "black", width = 1) ) 

```

## In which discipline(s) do you perform research?

```{r Q2_5}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q2.5)) %>%
    select(Q1.1,Q2.5)


datatable(dat, rownames = FALSE)
```

## Age

```{r Q2_6}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q2.6)) %>%
    select(Q1.1, Q2.6)

ggplot(dat, aes(x = Q2.6, fill = Q1.1)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())

ggplot(dat, aes(x = Q2.6, fill = Q1.1)) +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}

dat %>%
  group_by(Q1.1, Q2.6) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 ) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

## How many years have you worked in research?

```{r Q2_7}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q2.7)) %>%
    select(Q1.1, Q2.7, Q2.6)


dat$Q2.7 = factor(dat$Q2.7, levels = c("Less than 1 year", "1 - 5 years",
                                            "11 - 15 years", "16-20 years",
                                            "6 - 10 years", "More than 20 years"))


ggplot(dat, aes(x = Q2.7, fill = Q1.1)) +
#    facet_wrap("Q2.6") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())

ggplot(dat, aes(x = Q2.7, fill = Q1.1)) +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}
dat %>%
  group_by(Q1.1, Q2.7) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 ) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

## Gender

```{r Q2_8}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q2.8)) %>%
    select(Q1.1, Q2.7, Q2.6, Q2.8)

ggplot(dat, aes(x = Q2.8, fill = Q1.1)) +
#    facet_wrap("Q1.1") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())

ggplot(dat, aes(x = Q2.8, fill = Q1.1)) +
#    facet_wrap("Q1.1") +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}

dat %>%
  group_by(Q1.1, Q2.8) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 ) %>%
  autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q2.7)) %>%
    filter(Q2.8 == 'Female' | Q2.8 == 'Male') %>%
    select(Q1.1, Q2.7, Q2.8)

dat$Q2.7 = factor(dat$Q2.7, levels = c("Less than 1 year", "1 - 5 years",
                                            "11 - 15 years", "16-20 years",
                                            "6 - 10 years", "More than 20 years"))

ggplot(dat, aes(x = Q2.7, fill = Q2.8)) +
    facet_wrap("Q1.1") +
    geom_bar(position="dodge") + 
    labs(x = 'Years of experience in research', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')

ggplot(dat, aes(x = Q2.7, fill = Q2.8)) +
    facet_wrap("Q1.1") +
    geom_bar(position = 'fill') + 
    labs(x = 'Years of experience in research', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')
```

```{r}
dat %>%
  group_by(Q1.1, Q2.8, Q2.7) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 ) %>%
  autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

## How often do you work on projects that have the following team size?

```{r Q2_9}
dat = dat_na %>%
    filter(!is.na(Q1.1))


dat = dat[,c("Q1.1", "Q2.9_1", "Q2.9_2", "Q2.9_3", "Q2.9_4")]
colnames(dat) = c('Profile', '1 Person', '2-5 People', '6-20 People', 'More than 20 People')
datm = melt(dat, id.vars = 'Profile', value.name = 'Frequency', variable.name = 'Team size')

datm$Frequency = factor(datm$Frequency, levels = c("Never", "Sometimes",
                                            "About half the time", "Most of the time",
                                            "Always"))

datmm = datm %>%
    filter(!is.na(Frequency))

ggplot(datmm, aes(x = `Team size`, fill = Frequency)) +
    facet_wrap("Profile") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())

ggplot(datmm, aes(x = `Team size`, fill = Frequency)) +
    facet_wrap("Profile") +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())
```

```{r}
datmm %>%
  mutate(Team_size = `Team size`) %>%
  select(-`Team size`) %>%
  group_by(Profile, Team_size, Frequency) %>%
  tally() %>%
  left_join(tmp, by = c("Profile"="Q1.1")) %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Profile + Team_size) %>%
  autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

# Software Development Practices

## To what extent was the software targeted at each of these groups of users?

```{r Q3_2}
dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Q1.1, Q3.2_1, Q3.2_2, Q3.2_3, Q3.2_4)

datm = reshape2::melt(dat, id.vars = 'Q1.1')
colnames(datm) = c('Q1.1', 'Question', 'Choice')

datm$Choice = factor(datm$Choice, levels = c('Not at all', 'Secondary target', 'Primary target'))

datmm = datm %>%
      filter(!is.na(Choice))

ggplot(datmm, aes(x = Question, fill = Choice)) +
    facet_wrap('Q1.1') +
    geom_bar(position='dodge') + 
    labs(x = '', y = 'Frequency') +
    scale_x_discrete(labels = c("Just me", "Just my team", "Just my discipline", "More than one discipline"), breaks = c("Q3.2_1", "Q3.2_2", "Q3.2_3", "Q3.2_4")) +
    theme(axis.text.x = element_text(angle = 30, hjust = 1))

ggplot(datmm, aes(x = Question, fill = Choice)) +
    facet_wrap('Q1.1') +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    scale_x_discrete(labels = c("Just me", "Just my team", "Just my discipline", "More than one discipline"), breaks = c("Q3.2_1", "Q3.2_2", "Q3.2_3", "Q3.2_4")) +
    theme(axis.text.x = element_text(angle = 30, hjust = 1))

```

```{r}
datmm %>%
  group_by(Q1.1, Question, Choice) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 + Question) %>%
  autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

## What percent of your time did you actually spend in the following activities (total should be 100%)?

```{r fig1}
# perhaps change outliers to smaller
dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Q1.1, Q3.3_1, Q3.3_2, Q3.3_3, Q3.3_4, Q3.3_5, Q3.3_6, Q3.3_7, Q3.3_8, Q3.3_9, Q3.3_10)

datm = reshape2::melt(dat, id.vars = 'Q1.1')
colnames(datm) = c('Q1.1', 'Question', 'Choice')

datm$Choice = as.numeric(datm$Choice)

levels(datm$Question) = c("Requirements", "Software",
                                   "Coding", "Testing", "Debugging", "Maintenance", "Documentation", "Meetings", "Training", "Other")

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(fill = Q1.1, x = Question, y = Choice)) +
    geom_boxplot(fatten = NULL, outlier.size = .5) +
    stat_summary(fun = mean, geom = "errorbar",
                 aes(ymax = ..y.., ymin = ..y..),
                 width = .75, linetype = "solid", position = "dodge", color = "black") +
    labs(title = NULL, x = NULL, y = '% Time',
         caption = "Middle line indicates mean.") +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}
datmm %>%
  group_by(Q1.1, Question) %>%
  summarize(mean = round(mean(Choice),2), sd = round(sd(Choice),2)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1) %>%
  autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```


## What percent of time would you have liked to have spent in each activity (total should be 100%)?

```{r Q3_4}
dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Q1.1, Q3.4_1, Q3.4_2, Q3.4_3, Q3.4_4, Q3.4_5, Q3.4_6, Q3.4_7, Q3.4_8, Q3.4_9, Q3.4_10)

datm = reshape2::melt(dat, id.vars = 'Q1.1')
colnames(datm) = c('Q1.1', 'Question', 'Choice')

datm$Choice = as.numeric(datm$Choice)

levels(datm$Question) = c("Requirements", "Software",
                                   "Coding", "Testing", "Debugging", "Maintenance", "Documentation", "Meetings", "Training", "Other")

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(fill = Q1.1, x = Question, y = Choice)) +
    geom_boxplot(fatten = NULL, outlier.size = .5) +
    stat_summary(fun = mean, geom = "errorbar",
                 aes(ymax = ..y.., ymin = ..y..),
                 width = .75, linetype = "solid", position = "dodge", color = "black") +
    labs(title = NULL, x = NULL, y = '% Time',
         caption = "Middle line indicates mean.") +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}
datmm %>%
  group_by(Q1.1, Question) %>%
  summarize(mean = round(mean(Choice),2), sd = round(sd(Choice),2)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1) %>%
  autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```


## Comparative

```{r Q3_3_Q3_4_comp}

dat1 = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Q1.1, Q3.3_1, Q3.3_2, Q3.3_3, Q3.3_4, Q3.3_5, Q3.3_6, Q3.3_7, Q3.3_8, Q3.3_9, Q3.3_10)

dat2 = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Q1.1,
           Q3.4_1, Q3.4_2, Q3.4_3, Q3.4_4, Q3.4_5, Q3.4_6, Q3.4_7, Q3.4_8, Q3.4_9, Q3.4_10)

datm1 = reshape2::melt(dat1, id.vars = 'Q1.1') %>%
  mutate(Time = 'SpentTime')
datm2 = reshape2::melt(dat2, id.vars = 'Q1.1') %>%
  mutate(Time = 'IdealSpentTime')

datm1 =  datm1 %>%
  mutate(value = as.numeric(value),
         Question = as.character(variable),
         Question = ifelse(Question=="Q3.3_1", "Requirements",
                    ifelse(Question=="Q3.3_2", "Software",
                    ifelse(Question=="Q3.3_3", "Coding",
                    ifelse(Question=="Q3.3_4", "Testing",
                    ifelse(Question=="Q3.3_5", "Debugging",
                    ifelse(Question=="Q3.3_6", "Maintenance",
                    ifelse(Question=="Q3.3_7", "Documentation",
                    ifelse(Question=="Q3.3_8", "Meetings",
                    ifelse(Question=="Q3.3_9", "Training",
                    ifelse(Question=="Q3.3_10", "Other", NA))))))))))) %>%
  select(-variable)

datm2 =  datm2 %>%
  mutate(value = as.numeric(value),
         Question = as.character(variable),
         Question = ifelse(Question=="Q3.4_1", "Requirements",
                    ifelse(Question=="Q3.4_2", "Software",
                    ifelse(Question=="Q3.4_3", "Coding",
                    ifelse(Question=="Q3.4_4", "Testing",
                    ifelse(Question=="Q3.4_5", "Debugging",
                    ifelse(Question=="Q3.4_6", "Maintenance",
                    ifelse(Question=="Q3.4_7", "Documentation",
                    ifelse(Question=="Q3.4_8", "Meetings",
                    ifelse(Question=="Q3.4_9", "Training",
                    ifelse(Question=="Q3.4_10", "Other", NA))))))))))) %>%
  select(-variable)

datm = rbind(datm1, datm2) %>%
  mutate(Question = factor(Question, levels = c("Requirements",
                                                "Software",
                                                "Coding",
                                                "Testing",
                                                "Debugging",
                                                "Maintenance",
                                                "Documentation",
                                                "Meetings",
                                                "Training",
                                                "Other")))

datm %>%
  ggplot(aes(x = Q1.1, fill = Time, y = value)) + 
  facet_wrap("Question") +
  geom_boxplot(fatten = NULL, outlier.size = .5) +
    stat_summary(fun = mean, geom = "errorbar",
                 aes(ymax = ..y.., ymin = ..y..),
                 width = .75, linetype = "solid", position = "dodge", color = "black") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.position = "bottom",
        axis.title.y = element_text(size = 10)) +
  labs(title =str_wrap("Are respondents spending more time on tasks than they would like ideally?", 70),
       y = "% of time")
```


Due to the large difference in group sizes (Combination having n = 544 and Developers having n = 89), ANCOVA with type 3 sums of squares is run for checking differences between groups. When grouping is ignored, a paired t-test is used instead.

T-tests show that the Current(Q3.3) and Ideal(Q3.4) questions all have significantly different means when grouping is ignored.

ANCOVA shows that there are 2 activities Developers and Combination researchers differ significantly on. 

Developers are more likely to express wanting to spend more time on maintenance than those in the Combination grouping.  (Q3.3_6 and Q3.4_6)

On the other hand, those in the combination group are more likely to want to allocate more time to meetings in their ideal scheduling than Developers.  (Q3.3_8 and Q3.4_8)


### Statistical Tests {.tabset .tabset-dropdown}

#### Requirements

```{r}
Question = c("Requirements", "Software","Coding", "Testing", "Debugging", "Maintenance", "Documentation", "Meetings", "Training", "Other")

check = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers' & !is.na(Q3.3_1) & !is.na(Q3.4_1)) %>%
    select(Q1.1, Q3.3_1,Q3.4_1) %>%
  mutate(Q3.3_1 = as.numeric(Q3.3_1),
         Q3.4_1 = as.numeric(Q3.4_1))
colnames(check) = c('Group', 'Current', 'Ideal')

car::Anova(lm(Ideal ~ Current*Group, data = check, contrasts = list(Group = contr.poly)),
           type = 3)
t.test(Pair(Current, Ideal)~1 ,data=check)
```

#### Software

```{r}
check = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers' & !is.na(Q3.3_2) & !is.na(Q3.4_2)) %>%
    select(Q1.1, Q3.3_2,Q3.4_2) %>%
  mutate(Q3.3_2 = as.numeric(Q3.3_2),
         Q3.4_2 = as.numeric(Q3.4_2))
colnames(check) = c('Group', 'Current', 'Ideal')

car::Anova(lm(Ideal ~ Current*Group, data = check, contrasts = list(Group = contr.poly)),
           type = 3)
t.test(Pair(Current, Ideal)~1 ,data=check)
```

#### Coding

```{r}
check = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers' & !is.na(Q3.3_3) & !is.na(Q3.4_3)) %>%
    select(Q1.1, Q3.3_3,Q3.4_3) %>%
  mutate(Q3.3_3 = as.numeric(Q3.3_3),
         Q3.4_3 = as.numeric(Q3.4_3))
colnames(check) = c('Group', 'Current', 'Ideal')

car::Anova(lm(Ideal ~ Current*Group, data = check, contrasts = list(Group = contr.poly)),
           type = 3)
t.test(Pair(Current, Ideal)~1 ,data=check)
```

#### Testing

```{r}
check = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers' & !is.na(Q3.3_4) & !is.na(Q3.4_4)) %>%
    select(Q1.1, Q3.3_4,Q3.4_4) %>%
  mutate(Q3.3_4 = as.numeric(Q3.3_4),
         Q3.4_4 = as.numeric(Q3.4_4))
colnames(check) = c('Group', 'Current', 'Ideal')

car::Anova(lm(Ideal ~ Current*Group, data = check, contrasts = list(Group = contr.poly)),
           type = 3)
t.test(Pair(Current, Ideal)~1 ,data=check)
```

#### Debugging

```{r}
check = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers' & !is.na(Q3.3_5) & !is.na(Q3.4_5)) %>%
    select(Q1.1, Q3.3_5,Q3.4_5) %>%
  mutate(Q3.3_5 = as.numeric(Q3.3_5),
         Q3.4_5 = as.numeric(Q3.4_5))
colnames(check) = c('Group', 'Current', 'Ideal')

car::Anova(lm(Ideal ~ Current*Group, data = check, contrasts = list(Group = contr.poly)),
           type = 3)
t.test(Pair(Current, Ideal)~1 ,data=check)

#### DIFFERENT
```

#### Maintenance

```{r}
check = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers' & !is.na(Q3.3_6) & !is.na(Q3.4_6)) %>%
    select(Q1.1, Q3.3_6,Q3.4_6) %>%
  mutate(Q3.3_6 = as.numeric(Q3.3_6),
         Q3.4_6 = as.numeric(Q3.4_6))
colnames(check) = c('Group', 'Current', 'Ideal')

car::Anova(lm(Ideal ~ Current*Group, data = check, contrasts = list(Group = contr.poly)),
           type = 3)

emmeans::emtrends(lm(Ideal ~ Current*Group,
                     data = check, contrasts = list(Group = contr.poly)),
                  "Group", var = "Current")
# devs' ideal is more likely to be higher than their current compared to non-devs
t.test(Pair(Current, Ideal)~1 ,data=check)
```

#### Documentation

```{r}

check = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers' & !is.na(Q3.3_7) & !is.na(Q3.4_7)) %>%
    select(Q1.1, Q3.3_7,Q3.4_7) %>%
  mutate(Q3.3_7 = as.numeric(Q3.3_7),
         Q3.4_7 = as.numeric(Q3.4_7))
colnames(check) = c('Group', 'Current', 'Ideal')

car::Anova(lm(Ideal ~ Current*Group, data = check, contrasts = list(Group = contr.poly)),
           type = 3)
t.test(Pair(Current, Ideal)~1 ,data=check)
```

#### Meetings

```{r}
check = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers' & !is.na(Q3.3_8) & !is.na(Q3.4_8)) %>%
    select(Q1.1, Q3.3_8,Q3.4_8) %>%
  mutate(Q3.3_8 = as.numeric(Q3.3_8),
         Q3.4_8 = as.numeric(Q3.4_8))
colnames(check) = c('Group', 'Current', 'Ideal')

car::Anova(lm(Ideal ~ Current*Group, data = check, contrasts = list(Group = contr.poly)),
           type = 3)

emmeans::emtrends(lm(Ideal ~ Current*Group,
                     data = check, contrasts = list(Group = contr.poly)),
                  "Group", var = "Current")
# combinations' ideal is more likely to be higher than their current compared to devs
t.test(Pair(Current, Ideal)~1 ,data=check)
```

#### Training

```{r}
check = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers' & !is.na(Q3.3_9) & !is.na(Q3.4_9)) %>%
    select(Q1.1, Q3.3_9,Q3.4_9) %>%
  mutate(Q3.3_9 = as.numeric(Q3.3_9),
         Q3.4_9 = as.numeric(Q3.4_9))
colnames(check) = c('Group', 'Current', 'Ideal')

car::Anova(lm(Ideal ~ Current*Group, data = check, contrasts = list(Group = contr.poly)),
           type = 3)
t.test(Pair(Current, Ideal)~1 ,data=check)
```

#### Other

```{r}
check = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers' & !is.na(Q3.3_10) & !is.na(Q3.4_10)) %>%
    select(Q1.1, Q3.3_10,Q3.4_10) %>%
  mutate(Q3.3_10 = as.numeric(Q3.3_10),
         Q3.4_10 = as.numeric(Q3.4_10))
colnames(check) = c('Group', 'Current', 'Ideal')

car::Anova(lm(Ideal ~ Current*Group, data = check, contrasts = list(Group = contr.poly)),
           type = 3)
t.test(Pair(Current, Ideal)~1 ,data=check)
```




## Which of the following types of testing did you employ?

```{r Q3_5}
dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Q1.1, Q3.5_1, Q3.5_2, Q3.5_3, Q3.5_4, Q3.5_5)

datm = reshape2::melt(dat, id.vars = 'Q1.1')
colnames(datm) = c('Q1.1', 'Question', 'Choice')

datm$Choice = factor(datm$Choice, levels = c('Never', 'Rarely', 'Somewhat', "Frequently"))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x = Question, fill = Choice)) +
    facet_wrap('Q1.1') + 
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    scale_x_discrete(labels = c("Unit", "Integration", "System", "User", "Regression"), breaks = c("Q3.5_1", "Q3.5_2", "Q3.5_3", "Q3.5_4", "Q3.5_5")) +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())

ggplot(datmm, aes(x = Question, fill = Choice)) +
    facet_wrap('Q1.1') + 
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Frequency') +
    scale_x_discrete(labels = c("Unit", "Integration", "System", "User", "Regression"), breaks = c("Q3.5_1", "Q3.5_2", "Q3.5_3", "Q3.5_4", "Q3.5_5")) +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}
datmm %>%
  group_by(Q1.1, Question, Choice) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 + Question) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

## Did you release the software under an open-source license?

```{r Q3_6}
dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    filter(!is.na(Q3.6)) %>%
    select(Q1.1, Q3.6)

dat$Q3.6 = factor(dat$Q3.6)

ggplot(dat, aes(x = Q1.1, fill = Q3.6)) +
    geom_bar(position="dodge") + 
    labs( x = '', y = 'Frequency') +
    theme(legend.title = element_blank())

ggplot(dat, aes(x = Q1.1, fill = Q3.6)) +
    geom_bar(position = 'fill') + 
    labs( x = '', y = 'Proportion')  +
    theme(legend.title = element_blank())
```

```{r}
dat %>%
  group_by(Q1.1, Q3.6) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

# Development Infrastructure and Tools

## In the last 5 years, how much experience do you have with each of the following types of projects

```{r Q4_2}
dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Q1.1, Q4.2_1, Q4.2_2, Q4.2_3, Q4.2_4)

datm = reshape2::melt(dat, id.vars = 'Q1.1')
colnames(datm) = c('Q1.1', 'Question', 'Choice')

datm$Choice = factor(datm$Choice, levels = c('None', '1-3 projects', '4+ projects'))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x = Question, fill = Choice)) +
    facet_wrap('Q1.1') +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    scale_x_discrete(labels = c("Single developer", "Co-located team", "Distributed team", "Open source community"), breaks = c("Q4.2_1", "Q4.2_2", "Q4.2_3", "Q4.2_4")) +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())

ggplot(datmm, aes(x = Question, fill = Choice)) +
    facet_wrap('Q1.1') +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    scale_x_discrete(labels = c("Single developer", "Co-located team", "Distributed team", "Open source community"), breaks = c("Q4.2_1", "Q4.2_2", "Q4.2_3", "Q4.2_4")) +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}
datmm %>%
  group_by(Q1.1, Question, Choice) %>%
  tally() %>%
  left_join(tmp, by = "Q1.1") %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1 + Question) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

## How well do current tools support each of the following activities?

```{r fig3}
dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Q1.1, Q4.3_1, Q4.3_2, Q4.3_3, Q4.3_4, Q4.3_5, Q4.3_6, Q4.3_7)

datm = reshape2::melt(dat, id.vars = 'Q1.1')
colnames(datm) = c('Profile', 'Question', 'Choice')

datm$Choice = factor(datm$Choice, levels = c('Not supported at all', 'Slightly supported', 'Moderately supported', 'Very supported', 'Extremely supported'))
datm$Question = factor(datm$Question)
levels(datm$Question) = c("Req. Gathering\n & Documentation", "Software Architecture\n& Design",
                                   "Coding", "Testing", "Debugging", "Maintenance", "Documentation")

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position="bottom",
          legend.title = element_blank()) +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))

ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position="bottom",
          legend.title = element_blank()) +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))

```

```{r}
datmm %>%
  group_by(Profile, Question, Choice) %>%
  tally() %>%
  left_join(tmp, by = c("Profile"="Q1.1")) %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Profile + Question) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

# Training

## Have you received training for software development?

```{r Q5_2}
dat_na = dat_na %>%
  mutate(Gender = ifelse(Q2.8%in%c("Female", "Male"), Q2.8, 
                         NA),
         CareerStage = factor(Q2.7, levels = c("Less than 1 year" ,
                                               "1 - 5 years",
                                               "6 - 10 years",
                                               "11 - 15 years",
                                               "16-20 years",
                                               "More than 20 years")))

tmp3 = dat_na %>%
  group_by(CareerStage) %>%
  tally()

tmp2 = dat_na %>%
  group_by(Gender) %>%
  tally()

tmp4 = dat_na %>%
    filter(!is.na(Q1.1)) %>% # & !is.na(Q5.2)) %>%
  group_by(Q1.1) %>%
  tally()

dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q5.2)) %>%
    select(Q1.1, Q5.2)

dat$Q5.2 = factor(dat$Q5.2)

ggplot(dat, aes(x = Q1.1, fill = Q5.2)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position="bottom",
          legend.title = element_blank())
```

```{r}
urssi_analysis1(dat_na, x = "Q1.1", fill = "Q5.2")
```

```{r}
ggplot(dat, aes(x = Q1.1, fill = Q5.2)) +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position="bottom",
          legend.title = element_blank())


```

```{r}
urssi_analysis1(dat_na, x = "Gender", fill = "Q5.2")
```

```{r}
urssi_analysis2(dat_na, x = "Gender", fill = "Q5.2")
```

```{r}
urssi_analysis3(dat_na, x = "Gender", fill = "Q5.2")

```

```{r}
urssi_analysis1(dat_na, x = "CareerStage", fill = "Q5.2")
```

```{r}
urssi_analysis2(dat_na, x = "CareerStage", fill = "Q5.2")
```

```{r}
urssi_analysis3(dat_na, x = "CareerStage", fill = "Q5.2")

```


### Where? 

```{r Q5_3}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q5.3)) %>%
    select(Q1.1, Q5.3, Q5.3_4_TEXT)

dat$ClassSchool = ifelse(str_detect(dat$Q5.3, 'Class / school')==T,'Yes','No')
dat$OnlineSD = ifelse(str_detect(dat$Q5.3, 'Online self-directed')==T,'Yes','No')
dat$Carpentry = ifelse(str_detect(dat$Q5.3, 'Carpentry')==T,'Yes','No')
dat$Other = ifelse(str_detect(dat$Q5.3, 'Other')==T,'Yes','No')


datm = reshape2::melt(dat[,c("Q1.1", "ClassSchool", "OnlineSD","Carpentry", "Other")], id.vars = 'Q1.1')
colnames(datm) = c('Profile', 'Question', 'Choice')

datm$Choice = factor(datm$Choice)
datm$Profile = factor(datm$Profile)
levels(datm$Question) = levels = c('Class / school', 'Online self-directed', 'Carpentry', 'Other')

ggplot(datm, aes(x= Question, fill = Choice)) +
    facet_wrap('Profile') + 
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1))

ggplot(datm, aes(x= Question, fill = Choice)) +
    facet_wrap('Profile') + 
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
datm %>%
  group_by(Profile, Question, Choice) %>%
  tally() %>%
  left_join(tmp, by = c("Profile"="Q1.1")) %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Profile + Question) %>%
  autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r Q5_3_g}
dat = dat_na %>%
    filter(!is.na(Gender) & !is.na(Q5.3)) %>%
    select(Gender, Q5.3, Q5.3_4_TEXT)

dat$ClassSchool = ifelse(str_detect(dat$Q5.3, 'Class / school')==T,'Yes','No')
dat$OnlineSD = ifelse(str_detect(dat$Q5.3, 'Online self-directed')==T,'Yes','No')
dat$Carpentry = ifelse(str_detect(dat$Q5.3, 'Carpentry')==T,'Yes','No')
dat$Other = ifelse(str_detect(dat$Q5.3, 'Other')==T,'Yes','No')


datm = reshape2::melt(dat[,c("Gender", "ClassSchool", "OnlineSD","Carpentry", "Other")], id.vars = 'Gender')
colnames(datm) = c('Profile', 'Question', 'Choice')

datm$Choice = factor(datm$Choice)
datm$Profile = factor(datm$Profile)
levels(datm$Question) = levels = c('Class / school', 'Online self-directed', 'Carpentry', 'Other')

ggplot(datm, aes(x= Question, fill = Choice)) +
    facet_wrap('Profile') + 
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1))

ggplot(datm, aes(x= Question, fill = Choice)) +
    facet_wrap('Profile') + 
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
datm %>%
  group_by(Profile, Question, Choice) %>%
  tally() %>%
  left_join(tmp2, by = c("Profile"="Gender")) %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Profile + Question) %>%
  autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q5_3_c}
dat = dat_na %>%
    filter(!is.na(CareerStage) & !is.na(Q5.3)) %>%
    select(CareerStage, Q5.3, Q5.3_4_TEXT)

dat$ClassSchool = ifelse(str_detect(dat$Q5.3, 'Class / school')==T,'Yes','No')
dat$OnlineSD = ifelse(str_detect(dat$Q5.3, 'Online self-directed')==T,'Yes','No')
dat$Carpentry = ifelse(str_detect(dat$Q5.3, 'Carpentry')==T,'Yes','No')
dat$Other = ifelse(str_detect(dat$Q5.3, 'Other')==T,'Yes','No')


datm = reshape2::melt(dat[,c("CareerStage", "ClassSchool", "OnlineSD","Carpentry", "Other")], id.vars = 'CareerStage')
colnames(datm) = c('Profile', 'Question', 'Choice')

datm$Choice = factor(datm$Choice)
datm$Profile = factor(datm$Profile)
levels(datm$Question) = levels = c('Class / school', 'Online self-directed', 'Carpentry', 'Other')

ggplot(datm, aes(x= Question, fill = Choice)) +
    facet_wrap('Profile') + 
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1))

ggplot(datm, aes(x= Question, fill = Choice)) +
    facet_wrap('Profile') + 
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
datm %>%
  group_by(Profile, Question, Choice) %>%
  tally() %>%
  left_join(tmp3, by = c("Profile"="CareerStage")) %>%
  mutate(n = n.x,
         Proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
  flextable() %>%
  merge_v(j = ~ Profile + Question) %>%
  autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```


## Do you believe there are sufficient opportunities available for exploring or obtaining new software skills?

```{r fig4}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q5.4)) %>%
    select(Q1.1, Q5.4)

dat$Q5.4 = factor(dat$Q5.4)

ggplot(dat, aes(x = Q1.1, fill = Q5.4)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())

ggplot(dat, aes(x = Q1.1, fill = Q5.4)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}
dat %>%
    group_by(Q1.1, Q5.4) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r}
urssi_analysis1(dat_na, x = "Gender", fill = "Q5.4")
```

```{r}
urssi_analysis2(dat_na, x = "Gender", fill = "Q5.4")
```

```{r}
urssi_analysis3(dat_na, x = "Gender", fill = "Q5.4")
```

```{r}

urssi_analysis1(dat_na, x = "CareerStage", fill = "Q5.4")
```

```{r}
urssi_analysis2(dat_na, x = "CareerStage", fill = "Q5.4")
```

```{r}
urssi_analysis3(dat_na, x = "CareerStage", fill = "Q5.4")
    
```


## Do you have sufficient time to take the types of training you need to be successful?

```{r fig5}
dat = dat_na %>%
    filter(!is.na(Q1.1) &!is.na(Q5.5)) %>%
    select(Q1.1, Q5.5)

dat$Q5.5 = factor(dat$Q5.5)

ggplot(dat, aes(x = Q1.1, fill = Q5.5)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())

ggplot(dat, aes(x = Q1.1, fill = Q5.5)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}
dat %>%
    group_by(Q1.1, Q5.5) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r}
urssi_analysis1(dat_na, x = "Gender", fill = "Q5.5")
```

```{r}
urssi_analysis2(dat_na, x = "Gender", fill = "Q5.5")
```

```{r}
urssi_analysis3(dat_na, x = "Gender", fill = "Q5.5")
```

```{r}

urssi_analysis1(dat_na, x = "CareerStage", fill = "Q5.5")
```

```{r}
urssi_analysis2(dat_na, x = "CareerStage", fill = "Q5.5")
```

```{r}
urssi_analysis3(dat_na, x = "CareerStage", fill = "Q5.5")

```


## For each of the following types of training (languages, development techniques, and project management), which mode of delivery do you prefer? Please select your top two modes of delivery preferences for each of the training types.

```{r fig6}
dat = dat_na %>%
    filter(!is.na(Q1.1)) %>%
    select(Q1.1, Q5.6_1)

dat$DT = ifelse(str_detect(dat$Q5.6_1, 'Development Techniques')==T,'Preferred','Not')
dat$PM = ifelse(str_detect(dat$Q5.6_1, 'Project Management')==T,'Preferred','Not')
dat$Languages = ifelse(str_detect(dat$Q5.6_1, 'Languages')==T,'Preferred','Not')


datm = reshape2::melt(dat[,c('Q1.1', 'DT', 'PM', 'Languages')], id.vars = 'Q1.1')
colnames(datm) = c('Q1.1', 'Type', 'Choice')
datm$Question = 'On-site custom training'

datmm = datm

for(i in 1:5){
    
    dat = dat_na[ ,c('Q1.1', c('Q5.6_2', 'Q5.6_3', 'Q5.6_4', 'Q5.6_5', 'Q5.6_6')[i])] %>%
            filter(!is.na(Q1.1))

    dat$DT = ifelse(str_detect(dat[,2], 'Development Techniques')==T,'Preferred','Not')
    dat$PM = ifelse(str_detect(dat[,2], 'Project Management')==T,'Preferred','Not')
    dat$Languages = ifelse(str_detect(dat[,2], 'Languages')==T,'Preferred','Not')
    
    
    datm = reshape2::melt(dat[,c('Q1.1', 'DT', 'PM', 'Languages')], id.vars = 'Q1.1')
    colnames(datm) = c('Q1.1', 'Type', 'Choice')
    datm$Question = c('Workshops', 'Carpentries', 
                      'Summer schools', 'MOOCs', 'Other')[i]
    
    datmm = rbind(datmm, datm)
    
}

datmmm = datmm %>%
        filter(Choice=='Preferred') %>%
        select(Type, Question, Q1.1)

datmmm$Type = ifelse(datmmm$Type == 'DT', 'Development Techniques', 
                     ifelse(datmmm$Type == 'PM', 'Project Management', 
                            ifelse(datmmm$Type == 'Languages', 'Languages', datmmm$Type)))

ggplot(datmmm, aes(x= Type, fill = Question)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')


ggplot(datmmm, aes(x= Type, fill = Question)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')

```

```{r}
datmmm %>%
    group_by(Q1.1, Question, Type) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1 + Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q5_6_g}
dat = dat_na %>%
    filter(!is.na(Gender)) %>%
    select(Gender, Q5.6_1)

dat$DT = ifelse(str_detect(dat$Q5.6_1, 'Development Techniques')==T,'Preferred','Not')
dat$PM = ifelse(str_detect(dat$Q5.6_1, 'Project Management')==T,'Preferred','Not')
dat$Languages = ifelse(str_detect(dat$Q5.6_1, 'Languages')==T,'Preferred','Not')


datm = reshape2::melt(dat[,c('Gender', 'DT', 'PM', 'Languages')], id.vars = 'Gender')
colnames(datm) = c('Gender', 'Type', 'Choice')
datm$Question = 'On-site custom training'

datmm = datm

for(i in 1:5){
    
    dat = dat_na[ ,c('Gender', c('Q5.6_2', 'Q5.6_3', 'Q5.6_4', 'Q5.6_5', 'Q5.6_6')[i])] %>%
            filter(!is.na(Gender))

    dat$DT = ifelse(str_detect(dat[,2], 'Development Techniques')==T,'Preferred','Not')
    dat$PM = ifelse(str_detect(dat[,2], 'Project Management')==T,'Preferred','Not')
    dat$Languages = ifelse(str_detect(dat[,2], 'Languages')==T,'Preferred','Not')
    
    
    datm = reshape2::melt(dat[,c('Gender', 'DT', 'PM', 'Languages')], id.vars = 'Gender')
    colnames(datm) = c('Gender', 'Type', 'Choice')
    datm$Question = c('Workshops', 'Carpentries', 
                      'Summer schools', 'MOOCs', 'Other')[i]
    
    datmm = rbind(datmm, datm)
    
}

datmmm = datmm %>%
        filter(Choice=='Preferred') %>%
        select(Type, Question, Gender)

datmmm$Type = ifelse(datmmm$Type == 'DT', 'Development Techniques', 
                     ifelse(datmmm$Type == 'PM', 'Project Management', 
                            ifelse(datmmm$Type == 'Languages', 'Languages', datmmm$Type)))

ggplot(datmmm, aes(x= Type, fill = Question)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')


ggplot(datmmm, aes(x= Type, fill = Question)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')

```

```{r}
datmmm %>%
    group_by(Gender, Question, Type) %>%
    tally() %>%
    left_join(tmp2, by = "Gender") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Gender + Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q5_6_c}
dat = dat_na %>%
    filter(!is.na(CareerStage)) %>%
    select(CareerStage, Q5.6_1)

dat$DT = ifelse(str_detect(dat$Q5.6_1, 'Development Techniques')==T,'Preferred','Not')
dat$PM = ifelse(str_detect(dat$Q5.6_1, 'Project Management')==T,'Preferred','Not')
dat$Languages = ifelse(str_detect(dat$Q5.6_1, 'Languages')==T,'Preferred','Not')


datm = reshape2::melt(dat[,c('CareerStage', 'DT', 'PM', 'Languages')], id.vars = 'CareerStage')
colnames(datm) = c('CareerStage', 'Type', 'Choice')
datm$Question = 'On-site custom training'

datmm = datm

for(i in 1:5){
    
    dat = dat_na[ ,c('CareerStage', c('Q5.6_2', 'Q5.6_3', 'Q5.6_4', 'Q5.6_5', 'Q5.6_6')[i])] %>%
            filter(!is.na(CareerStage))

    dat$DT = ifelse(str_detect(dat[,2], 'Development Techniques')==T,'Preferred','Not')
    dat$PM = ifelse(str_detect(dat[,2], 'Project Management')==T,'Preferred','Not')
    dat$Languages = ifelse(str_detect(dat[,2], 'Languages')==T,'Preferred','Not')
    
    
    datm = reshape2::melt(dat[,c('CareerStage', 'DT', 'PM', 'Languages')], id.vars = 'CareerStage')
    colnames(datm) = c('CareerStage', 'Type', 'Choice')
    datm$Question = c('Workshops', 'Carpentries', 
                      'Summer schools', 'MOOCs', 'Other')[i]
    
    datmm = rbind(datmm, datm)
    
}

datmmm = datmm %>%
        filter(Choice=='Preferred') %>%
        select(Type, Question, CareerStage)

datmmm$Type = ifelse(datmmm$Type == 'DT', 'Development Techniques', 
                     ifelse(datmmm$Type == 'PM', 'Project Management', 
                            ifelse(datmmm$Type == 'Languages', 'Languages', datmmm$Type)))

ggplot(datmmm, aes(x= Type, fill = Question)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')


ggplot(datmmm, aes(x= Type, fill = Question)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')

```

```{r}
datmmm %>%
    group_by(CareerStage, Question, Type) %>%
    tally() %>%
    left_join(tmp3, by = "CareerStage") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ CareerStage + Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

# Funding/Institutional Support

## Have you ever included costs for software development in a funding proposal?

```{r Q6_2}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q6.2)) %>%
    select(Q1.1, Q6.2)

dat$Q1.1 = factor(dat$Q1.1)
dat$Q6.2 = factor(dat$Q6.2)

ggplot(dat, aes(x= Q1.1, fill = Q6.2)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')


ggplot(dat, aes(x= Q1.1, fill = Q6.2)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')
```

```{r}
dat %>%
    group_by(Q1.1, Q6.2) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r}
urssi_analysis1(dat_na, x = "Gender", fill = "Q6.2")
```

```{r}
urssi_analysis2(dat_na, x = "Gender", fill = "Q6.2")
```

```{r}
urssi_analysis3(dat_na, x = "Gender", fill = "Q6.2")
```

```{r}

urssi_analysis1(dat_na, x = "CareerStage", fill = "Q6.2")
```

```{r}
urssi_analysis2(dat_na, x = "CareerStage", fill = "Q6.2")
```

```{r}
urssi_analysis3(dat_na, x = "CareerStage", fill = "Q6.2")

```

### Select all costs for software development in your funding proposals?

```{r Q6_3}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q6.3)) %>%
    select(Q1.1, Q6.3)

dat$`For developing new software` = ifelse(str_detect(dat$Q6.3, 'For developing new software')==T,'Yes','No')
dat$`For reusing existing software` = ifelse(str_detect(dat$Q6.3, 'For reusing existing software')==T,'Yes','No')
dat$`For maintaining / sustaining software` = ifelse(str_detect(dat$Q6.3, 'For maintaining / sustaining software')==T,'Yes','No')


datm = reshape2::melt(dat[,-2], id.vars = 'Q1.1', value.name = 'Choice', variable.name = 'Type')

datmm = datm %>%
        filter(Choice=='Yes') %>%
        select(Type, Q1.1)

ggplot(datmm, aes(x= Type, fill = Q1.1)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')


ggplot(datmm, aes(x= Type, fill = Q1.1)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')
```

```{r}
datmm %>%
    group_by(Q1.1, Type) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()


```

```{r Q6_3_g}
dat = dat_na %>%
    filter(!is.na(Gender) & !is.na(Q6.3)) %>%
    select(Gender, Q6.3)

dat$`For developing new software` = ifelse(str_detect(dat$Q6.3, 'For developing new software')==T,'Yes','No')
dat$`For reusing existing software` = ifelse(str_detect(dat$Q6.3, 'For reusing existing software')==T,'Yes','No')
dat$`For maintaining / sustaining software` = ifelse(str_detect(dat$Q6.3, 'For maintaining / sustaining software')==T,'Yes','No')


datm = reshape2::melt(dat[,-2], id.vars = 'Gender', value.name = 'Choice', variable.name = 'Type')

datmm = datm %>%
        filter(Choice=='Yes') %>%
        select(Type, Gender)

ggplot(datmm, aes(x= Type, fill = Gender)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')


ggplot(datmm, aes(x= Type, fill = Gender)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')
```

```{r}
datmm %>%
    group_by(Gender, Type) %>%
    tally() %>%
    left_join(tmp2, by = "Gender") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Gender) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()


```

```{r Q6_3_c}
dat = dat_na %>%
    filter(!is.na(CareerStage) & !is.na(Q6.3)) %>%
    select(CareerStage, Q6.3)

dat$`For developing new software` = ifelse(str_detect(dat$Q6.3, 'For developing new software')==T,'Yes','No')
dat$`For reusing existing software` = ifelse(str_detect(dat$Q6.3, 'For reusing existing software')==T,'Yes','No')
dat$`For maintaining / sustaining software` = ifelse(str_detect(dat$Q6.3, 'For maintaining / sustaining software')==T,'Yes','No')


datm = reshape2::melt(dat[,-2], id.vars = 'CareerStage', value.name = 'Choice', variable.name = 'Type')

datmm = datm %>%
        filter(Choice=='Yes') %>%
        select(Type, CareerStage)

ggplot(datmm, aes(x= Type, fill = CareerStage)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')


ggplot(datmm, aes(x= Type, fill = CareerStage)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')
```

```{r}
datmm %>%
    group_by(CareerStage, Type) %>%
    tally() %>%
    left_join(tmp3, by = "CareerStage") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ CareerStage) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()


```

## What percent of the funding for your software work comes from each of the following?

```{r fig7}
dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Q1.1, Q6.4_1, Q6.4_2, Q6.4_3, Q6.4_4, Q6.4_5, Q6.4_6, Q6.4_7, Q6.4_8, Q6.4_9)

datm = reshape2::melt(dat, id.vars = 'Q1.1', value.name = 'Choice', variable.name = 'Source')

datm$Choice = as.numeric(datm$Choice)


ggplot(datm, aes(x = Source, fill = Q1.1, y = Choice)) +
    geom_boxplot(fatten = NULL, outlier.size = .5) +
    stat_summary(fun = mean, geom = "errorbar",
                 aes(ymax = ..y.., ymin = ..y..),
                 width = .75, linetype = "solid", position = "dodge", color = "black") +
    labs(title = NULL, x = NULL, y = '% Funding',
         caption = "Middle line indicates mean.") +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank()) +
    scale_x_discrete(labels = c("NSF", "NIH",
                                   "DoD", "DoE", "NASA", "NOAA", "Private Foundation", "Your own institution", "Other"),
                        breaks = c("Q6.4_1", "Q6.4_2", "Q6.4_3", "Q6.4_4", "Q6.4_5", "Q6.4_6", "Q6.4_7", "Q6.4_8", "Q6.4_9"))

```

```{r}
datm %>%
  group_by(Q1.1, Source) %>%
  mutate(Source = ifelse(Source=="Q6.4_1","NSF", 
                  ifelse(Source=="Q6.4_2","NIH",
                  ifelse(Source=="Q6.4_3","DoD",
                  ifelse(Source=="Q6.4_4","DoE",
                  ifelse(Source=="Q6.4_5","NASA",
                  ifelse(Source=="Q6.4_6","NOAA",
                  ifelse(Source=="Q6.4_7","Private Foundation",
                  ifelse(Source=="Q6.4_8","Your own institution",
                  ifelse(Source=="Q6.4_9","Other", NA)))))))))) %>%
  summarize(mean = round(mean(Choice, na.rm=T),2), sd = round(sd(Choice, na.rm=T),2)) %>%  
  flextable() %>%
  merge_v(j = ~ Q1.1) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q6_4_g}
dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Gender, Q6.4_1, Q6.4_2, Q6.4_3, Q6.4_4, Q6.4_5, Q6.4_6, Q6.4_7, Q6.4_8, Q6.4_9)

datm = reshape2::melt(dat, id.vars = 'Gender', value.name = 'Choice', variable.name = 'Source')

datm$Choice = as.numeric(datm$Choice)


ggplot(datm, aes(x = Source, fill = Gender, y = Choice)) +
    geom_boxplot(fatten = NULL, outlier.size = .5) +
    stat_summary(fun = mean, geom = "errorbar",
                 aes(ymax = ..y.., ymin = ..y..),
                 width = .75, linetype = "solid", position = "dodge", color = "black") +
    labs(title = NULL, x = NULL, y = '% Funding',
         caption = "Middle line indicates mean.") +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank()) +
    scale_x_discrete(labels = c("NSF", "NIH",
                                   "DoD", "DoE", "NASA", "NOAA", "Private Foundation", "Your own institution", "Other"),
                        breaks = c("Q6.4_1", "Q6.4_2", "Q6.4_3", "Q6.4_4", "Q6.4_5", "Q6.4_6", "Q6.4_7", "Q6.4_8", "Q6.4_9"))
```

```{r}
datm %>%
  group_by(Gender, Source) %>%
  mutate(Source = ifelse(Source=="Q6.4_1","NSF", 
                  ifelse(Source=="Q6.4_2","NIH",
                  ifelse(Source=="Q6.4_3","DoD",
                  ifelse(Source=="Q6.4_4","DoE",
                  ifelse(Source=="Q6.4_5","NASA",
                  ifelse(Source=="Q6.4_6","NOAA",
                  ifelse(Source=="Q6.4_7","Private Foundation",
                  ifelse(Source=="Q6.4_8","Your own institution",
                  ifelse(Source=="Q6.4_9","Other", NA)))))))))) %>%
  summarize(mean = round(mean(Choice, na.rm=T),2), sd = round(sd(Choice, na.rm=T),2)) %>%
  flextable() %>%
  merge_v(j = ~ Gender) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q6_4_c}
dat = dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(CareerStage, Q6.4_1, Q6.4_2, Q6.4_3, Q6.4_4, Q6.4_5, Q6.4_6, Q6.4_7, Q6.4_8, Q6.4_9)

datm = reshape2::melt(dat, id.vars = 'CareerStage', value.name = 'Choice', variable.name = 'Source')

datm$Choice = as.numeric(datm$Choice)


ggplot(datm, aes(x = Source, fill = CareerStage, y = Choice)) +
    geom_boxplot(fatten = NULL, outlier.size = .5) +
    stat_summary(fun = mean, geom = "errorbar",
                 aes(ymax = ..y.., ymin = ..y..),
                 width = .75, linetype = "solid", position = "dodge", color = "black") +
    labs(title = NULL, x = NULL, y = '% Funding',
         caption = "Middle line indicates mean.") +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank()) +
    scale_x_discrete(labels = c("NSF", "NIH",
                                   "DoD", "DoE", "NASA", "NOAA", "Private Foundation", "Your own institution", "Other"),
                        breaks = c("Q6.4_1", "Q6.4_2", "Q6.4_3", "Q6.4_4", "Q6.4_5", "Q6.4_6", "Q6.4_7", "Q6.4_8", "Q6.4_9")) 

```

```{r}
datm %>%
  group_by(CareerStage, Source) %>%
  mutate(Source = ifelse(Source=="Q6.4_1","NSF", 
                  ifelse(Source=="Q6.4_2","NIH",
                  ifelse(Source=="Q6.4_3","DoD",
                  ifelse(Source=="Q6.4_4","DoE",
                  ifelse(Source=="Q6.4_5","NASA",
                  ifelse(Source=="Q6.4_6","NOAA",
                  ifelse(Source=="Q6.4_7","Private Foundation",
                  ifelse(Source=="Q6.4_8","Your own institution",
                  ifelse(Source=="Q6.4_9","Other", NA)))))))))) %>%
  summarize(mean = round(mean(Choice, na.rm=T),2), sd = round(sd(Choice, na.rm=T),2)) %>%
  flextable() %>%
  merge_v(j = ~ CareerStage) %>%
  autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

## Does your institution provide support for your research software development activities in the following ways

```{r fig8}
dat = dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Q1.1, Q6.5_1, Q6.5_2, Q6.5_3, Q6.5_4)

datm = reshape2::melt(dat, id.vars = 'Q1.1')
colnames(datm) = c('Q1.1', 'Question', 'Choice')

datm$Question = ifelse(datm$Question=='Q6.5_1', 'Financial',
                       ifelse(datm$Question=='Q6.5_2','Infrastructural',
                              ifelse(datm$Question=='Q6.5_3','Consulting/ \n RSE Support',
                                     ifelse(datm$Question=='Q6.5_4','Other',datm$Question))))


datm$Choice = factor(datm$Choice, levels=c('No', 'Yes, but inadequate level of support','Yes, adequate level of support'))

datmm = datm %>%
    filter(!is.na(Choice))




ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))

```

```{r}
datmm %>%
    group_by(Q1.1, Question, Choice) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1 + Question) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q6_5_g}
dat = dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Gender, Q6.5_1, Q6.5_2, Q6.5_3, Q6.5_4)

datm = reshape2::melt(dat, id.vars = 'Gender')
colnames(datm) = c('Gender', 'Question', 'Choice')

datm$Question = ifelse(datm$Question=='Q6.5_1', 'Financial',
                       ifelse(datm$Question=='Q6.5_2','Infrastructural',
                              ifelse(datm$Question=='Q6.5_3','Consulting/ \n RSE Support',
                                     ifelse(datm$Question=='Q6.5_4','Other',datm$Question))))


datm$Choice = factor(datm$Choice, levels=c('No', 'Yes, but inadequate level of support','Yes, adequate level of support'))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

```{r}

datmm %>%
    group_by(Gender, Question, Choice) %>%
    tally() %>%
    left_join(tmp2, by = "Gender") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Gender + Question) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q6_5_c}
dat = dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(CareerStage, Q6.5_1, Q6.5_2, Q6.5_3, Q6.5_4)

datm = reshape2::melt(dat, id.vars = 'CareerStage')
colnames(datm) = c('CareerStage', 'Question', 'Choice')

datm$Question = ifelse(datm$Question=='Q6.5_1', 'Financial',
                       ifelse(datm$Question=='Q6.5_2','Infrastructural',
                              ifelse(datm$Question=='Q6.5_3','Consulting/ \n RSE Support',
                                     ifelse(datm$Question=='Q6.5_4','Other',datm$Question))))


datm$Choice = factor(datm$Choice, levels=c('No', 'Yes, but inadequate level of support','Yes, adequate level of support'))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))

```

```{r}
datmm %>%
    group_by(CareerStage, Question, Choice) %>%
    tally() %>%
    left_join(tmp3, by = "CareerStage") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ CareerStage + Question) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

## Does your institution provide / support the research software development you need in the following ways

```{r Q6_6}
dat = dat = dat_na %>%
    filter(Q1.1 == 'Researchers') %>%
    select(Q1.1, Q6.6_1, Q6.6_2, Q6.6_3, Q6.6_4)

datm = reshape2::melt(dat, id.vars = 'Q1.1')
colnames(datm) = c('Q1.1', 'Question', 'Choice')

datm$Question = ifelse(datm$Question=='Q6.6_1', 'Financial',
                       ifelse(datm$Question=='Q6.6_2','Infrastructural',
                              ifelse(datm$Question=='Q6.6_3','Consulting/ \n RSE Support',
                                     ifelse(datm$Question=='Q6.6_4','Other',datm$Question))))

datm$Choice = factor(datm$Choice, levels=c('No', 'Yes, but inadequate level of support','Yes, adequate level of support'))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))

```

```{r}
datmm %>%
    group_by(Q1.1, Question, Choice) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1+Question) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r Q6_6_g}
dat = dat = dat_na %>%
    filter(Q1.1 == 'Researchers') %>%
    select(Gender, Q6.6_1, Q6.6_2, Q6.6_3, Q6.6_4)

datm = reshape2::melt(dat, id.vars = 'Gender')
colnames(datm) = c('Gender', 'Question', 'Choice')

datm$Question = ifelse(datm$Question=='Q6.6_1', 'Financial',
                       ifelse(datm$Question=='Q6.6_2','Infrastructural',
                              ifelse(datm$Question=='Q6.6_3','Consulting/ \n RSE Support',
                                     ifelse(datm$Question=='Q6.6_4','Other',datm$Question))))

datm$Choice = factor(datm$Choice, levels=c('No', 'Yes, but inadequate level of support','Yes, adequate level of support'))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))

```

```{r}
datmm %>%
    group_by(Gender, Question, Choice) %>%
    tally() %>%
    left_join(tmp2, by = "Gender") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Gender+Question) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r Q6_6_c}
dat = dat = dat_na %>%
    filter(Q1.1 == 'Researchers') %>%
    select(CareerStage, Q6.6_1, Q6.6_2, Q6.6_3, Q6.6_4)

datm = reshape2::melt(dat, id.vars = 'CareerStage')
colnames(datm) = c('CareerStage', 'Question', 'Choice')

datm$Question = ifelse(datm$Question=='Q6.6_1', 'Financial',
                       ifelse(datm$Question=='Q6.6_2','Infrastructural',
                              ifelse(datm$Question=='Q6.6_3','Consulting/ \n RSE Support',
                                     ifelse(datm$Question=='Q6.6_4','Other',datm$Question))))

datm$Choice = factor(datm$Choice, levels=c('No', 'Yes, but inadequate level of support','Yes, adequate level of support'))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Question, fill = Choice)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))

```

```{r}
datmm %>%
    group_by(CareerStage, Question, Choice) %>%
    tally() %>%
    left_join(tmp3, by = "CareerStage") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ CareerStage+Question) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

## What are the most significant gaps in your current institutional / organizational support of software related research?

```{r Q6_7}
dat = dat_na %>%
    filter( !is.na(Q6.7)) %>%
    select(Q1.1, Q6.7, Gender, CareerStage)

topics = list(funds=c("funds|money|funding|financial|salar|pay|paid|budget|/$|grants"),
              time = c("time|timeline|schedule"),
              appreciation = c("(do not care)|(not taken seriously)|(Nobody values what I do)|(creative pursuit on par with basic research)|recognition|appreciation|credit|(It's more about the culture)|(Lack f interest and commitment from administration. Dean of engineering who does not respect software development.)|Skepticism|(don't care about software)|(Not particularly valued by community)|(Recognizing that software development is a valid scientific)"),
              support = c("support"),
              communication = c("(lack of communication)|communicating|connection|integration|tension|understanding|(lack of collaboration)"),
              resources = c("platforms|(develop open source software)|infrastructrue|resources|(don't have a repository)|resources|space|(high speed internet connection)|licens|licenc|(slow computing)|purchase|hpc|hardware|platforms|(no office)|exascale"),
              direction = c("direction|(promotional track)|metrics|leadership|administration"),
              training = c("training|workshop|educat|(boot camp)|coursework"),
              software = c("development|maintenance|(software tool)"),
              personnel = c("recruit|hire|subcontracting|(competent manpower)|personnel|staffing|(lack of people)|(too few people)|(find people)|(Lack of experienced software developers)|(need more people)|(no software developers)|(Experts in computer systems who maintain computers)|(ability to hire)|(lack of properly trained)|(a team dedicated)|(love some in house consultants)|(depend on a single developer)|(retaining senior)|(Access to expertise)|(Subcritical mass of developers)|(Staff with specific knowledge)|(Lack of experienced programmers)|(difficult to hire)|(I have to do all of the development)|(Bioinformatics experts to analyze)|attrition|(organized help)|(lack of research software scientists)"))


#datatable(dat, rownames = FALSE)

dat = lapply(topics, FUN = function(x) str_detect(tolower(dat$Q6.7), x)) %>%
  cbind(dat)

dat1 =  dat %>%
    filter(!is.na(Q1.1) & !is.na(Q6.7)) %>%
    select(-c(Gender, CareerStage)) %>%
  melt(id="Q1.1", variable.name="topics") %>%
  filter(value==T)

dat2 =  dat %>%
    filter(!is.na(Gender) & !is.na(Q6.7)) %>%
    select(-c(Q1.1, CareerStage)) %>%
  melt(id="Gender", variable.name="topics") %>%
  filter(value==T)

dat3 =  dat %>%
    filter(!is.na(CareerStage) & !is.na(Q6.7)) %>%
    select(-c(Gender, Q1.1)) %>%
  melt(id="CareerStage", variable.name="topics") %>%
  filter(value==T)


tmp1 = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q6.7)) %>%
    group_by(Q1.1) %>%
  tally()
  

tmp2 = dat_na %>%
    filter(!is.na(Gender) & !is.na(Q6.7)) %>%
    group_by(Gender) %>%
  tally()

tmp3 = dat_na %>%
    filter(!is.na(CareerStage) & !is.na(Q6.7)) %>%
    group_by(CareerStage) %>%
  tally()
```

```{r}
dat1 %>%
  group_by(Q1.1, topics) %>%
  tally() %>%
  inner_join(tmp1, by = "Q1.1") %>%
  mutate(Q1.1 = ifelse(Q1.1=="Combination", "Combination\nn=197",
                       ifelse(Q1.1=="Developers", "Developers\nn=30",
                              "Researchers\nn=159")),
         n = n.x, #total_respondents = n.y,
         proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
          flextable() %>%
        merge_v(j = ~ .) %>%
        autofit() %>%
        border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
        fix_border_issues() 
```

TODO 
```{r eval = FALSE}

ggthemr("dust")

ggplot(dat1, aes(x = topics, fill = topics)) +
    geom_bar(position = 'dodge') + 
    labs(x = '', y = 'Count') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())

ggplot(dat1, aes(x = topics, fill = topics)) +
  facet_wrap("Q1.1", nrow = 3, scales = "free") +
    geom_bar(position = 'dodge') + 
    labs(x = '', y = 'Count') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())

```

```{r}
ggthemr("dust")
dat2 %>%
  group_by(Gender, topics) %>%
  tally() %>%
  inner_join(tmp2, by = "Gender") %>%
  mutate(Gender = ifelse(Gender=="Female", "Female\nn=268", "Male\nn=734"),
         n = n.x, #total_respondents = n.y,
         proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
          flextable() %>%
        merge_v(j = ~ .) %>%
        autofit() %>%
        border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
        fix_border_issues() 
```

```{r}
dat3 %>%
  group_by(CareerStage, topics) %>%
  tally() %>%
  inner_join(tmp3, by = "CareerStage") %>%
  mutate(CareerStage = ifelse(CareerStage=="1 - 5 years", "1 - 5 years\nn=20",
                       ifelse(CareerStage=="6 - 10 years", "6 - 10 years\nn=64",
                       ifelse(CareerStage=="11 - 15 years", "11 - 15 years\nn=68",
                       ifelse(CareerStage=="16-20 years", "16-20 years\nn=67",
                              "More than 20 years\nn=165")))),
         n = n.x, #total_respondents = n.y,
         proportion = percent(n.x/n.y)) %>%
  select(-c(n.x, n.y)) %>%
          flextable() %>%
        merge_v(j = ~ .) %>%
        autofit() %>%
        border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
        fix_border_issues() 


```

# Career Paths

## In your institution, which of the following positions are available for people whose primary role is to develop research software?

```{r Q7_2}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q7.2)) %>%
    select(Q1.1, Q7.2)

dat$Postdoc = ifelse(str_detect(dat$Q7.2, 'Postdoc')==T,'Yes','No')
dat$`Research Software Engineer` = ifelse(str_detect(dat$Q7.2, 'Research Software Engineer')==T,'Yes','No')
dat$`Research Programmer` = ifelse(str_detect(dat$Q7.2, 'Research Programmer')==T,'Yes','No')
dat$`Software Developer` = ifelse(str_detect(dat$Q7.2, 'Software Developer')==T,'Yes','No')
dat$Programmer = ifelse(str_detect(dat$Q7.2, '(?<![\\s])Programmer')==T,'Yes','No')
dat$Faculty = ifelse(str_detect(dat$Q7.2, '(?<![\\s])Faculty')==T,'Yes','No')
dat$`Research Faculty` = ifelse(str_detect(dat$Q7.2, 'Research Faculty')==T,'Yes','No')
dat$Other = ifelse(str_detect(dat$Q7.2, 'Other')==T,'Yes','No')


datm = reshape2::melt(dat[,-2], id.vars = 'Q1.1', value.name = 'Available', variable.name = 'Role')

datmm = datm %>%
    filter(Available == 'Yes')

ggplot(datmm, aes(x= Role, fill = Q1.1)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')


ggplot(datmm, aes(x= Role, fill = Q1.1)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') # + guides(fill=guide_legend(nrow=2,byrow=TRUE))

tmp = dat_na %>%
    filter(!is.na(Q1.1)) %>%
    group_by(Q1.1) %>%
  tally()
```

```{r}
datmm %>%
    group_by(Q1.1, Role) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q7_2_g}
dat = dat_na %>%
    filter(!is.na(Gender) & !is.na(Q7.2)) %>%
    select(Gender, Q7.2)

dat$Postdoc = ifelse(str_detect(dat$Q7.2, 'Postdoc')==T,'Yes','No')
dat$`Research Software Engineer` = ifelse(str_detect(dat$Q7.2, 'Research Software Engineer')==T,'Yes','No')
dat$`Research Programmer` = ifelse(str_detect(dat$Q7.2, 'Research Programmer')==T,'Yes','No')
dat$`Software Developer` = ifelse(str_detect(dat$Q7.2, 'Software Developer')==T,'Yes','No')
dat$Programmer = ifelse(str_detect(dat$Q7.2, '(?<![\\s])Programmer')==T,'Yes','No')
dat$Faculty = ifelse(str_detect(dat$Q7.2, '(?<![\\s])Faculty')==T,'Yes','No')
dat$`Research Faculty` = ifelse(str_detect(dat$Q7.2, 'Research Faculty')==T,'Yes','No')
dat$Other = ifelse(str_detect(dat$Q7.2, 'Other')==T,'Yes','No')


datm = reshape2::melt(dat[,-2], id.vars = 'Gender', value.name = 'Available', variable.name = 'Role')

datmm = datm %>%
    filter(Available == 'Yes')

ggplot(datmm, aes(x= Role, fill = Gender)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')


ggplot(datmm, aes(x= Role, fill = Gender)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') # + guides(fill=guide_legend(nrow=2,byrow=TRUE))

tmp2 = dat_na %>%
    filter(!is.na(Gender)) %>%
    group_by(Gender) %>%
  tally()
```

```{r}
datmm %>%
    group_by(Gender, Role) %>%
    tally() %>%
    left_join(tmp2, by = "Gender") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Gender) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q7_2_c}
dat = dat_na %>%
    filter(!is.na(CareerStage) & !is.na(Q7.2)) %>%
    select(CareerStage, Q7.2)

dat$Postdoc = ifelse(str_detect(dat$Q7.2, 'Postdoc')==T,'Yes','No')
dat$`Research Software Engineer` = ifelse(str_detect(dat$Q7.2, 'Research Software Engineer')==T,'Yes','No')
dat$`Research Programmer` = ifelse(str_detect(dat$Q7.2, 'Research Programmer')==T,'Yes','No')
dat$`Software Developer` = ifelse(str_detect(dat$Q7.2, 'Software Developer')==T,'Yes','No')
dat$Programmer = ifelse(str_detect(dat$Q7.2, '(?<![\\s])Programmer')==T,'Yes','No')
dat$Faculty = ifelse(str_detect(dat$Q7.2, '(?<![\\s])Faculty')==T,'Yes','No')
dat$`Research Faculty` = ifelse(str_detect(dat$Q7.2, 'Research Faculty')==T,'Yes','No')
dat$Other = ifelse(str_detect(dat$Q7.2, 'Other')==T,'Yes','No')


datm = reshape2::melt(dat[,-2], id.vars = 'CareerStage', value.name = 'Available', variable.name = 'Role')

datmm = datm %>%
    filter(Available == 'Yes')

ggplot(datmm, aes(x= Role, fill = CareerStage)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')


ggplot(datmm, aes(x= Role, fill = CareerStage)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') # + guides(fill=guide_legend(nrow=2,byrow=TRUE))

tmp3 = dat_na %>%
    filter(!is.na(CareerStage)) %>%
    group_by(CareerStage) %>%
  tally()
```

```{r}
datmm %>%
    group_by(CareerStage, Role) %>%
    tally() %>%
    left_join(tmp3, by = "CareerStage") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ CareerStage) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

## Is there opportunity for career advancement (e.g., tenure, more senior positions) for people whose primary role is to develop research software at your institution?

```{r fig10}
dat_na$Q7.3 = ifelse(dat_na$Q7.3=='No - I would have to move to another institution', 'No', 
                  ifelse(dat_na$Q7.3=="Dont know", "Don't know",
                         ifelse(dat_na$Q7.3=='Yes - in my current institution', 'Yes', NA)))

dat_na$Q7.3 = factor(dat_na$Q7.3, levels = c("Don't know", 'No', 'Yes'))


dat = dat_na %>%
  filter(!is.na(Q1.1) & !is.na(Q7.3)) %>%
  select(Q1.1, Q7.3)


```

```{r}
urssi_analysis1(dat_na, x = "Q1.1", fill = "Q7.3")
```

```{r}
urssi_analysis2(dat_na, x = "Q1.1", fill = "Q7.3")
```

```{r}
urssi_analysis3(dat_na, x = "Q1.1", fill = "Q7.3")
```

```{r}

urssi_analysis1(dat_na, x = "Gender", fill = "Q7.3")
```

```{r}
urssi_analysis2(dat_na, x = "Gender", fill = "Q7.3")
```

```{r}
urssi_analysis3(dat_na, x = "Gender", fill = "Q7.3")
```

```{r}
urssi_analysis1(dat_na, x = "CareerStage", fill = "Q7.3")
```

```{r}
urssi_analysis2(dat_na, x = "CareerStage", fill = "Q7.3")
```

```{r}
urssi_analysis3(dat_na, x = "CareerStage", fill = "Q7.3")


```

## With regard to hiring and maintaining a highly qualified software development staff, how important are the following concerns?

```{r fig11}
dat = dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Researchers') %>%
    select(Q1.1, Q7.4_1, Q7.4_2, Q7.4_3, Q7.4_4, Q7.4_5, Q7.4_6)

datm = reshape2::melt(dat, id.vars = 'Q1.1', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Not at all important', 'Slightly important', 'Moderately important', 'Very important', 'Extremely important'))
datm$Question = factor(datm$Question)
levels(datm$Question) = c("Future staff",
                          "Underrepresented groups",
                          "Across disciplines",
                          "Competing with industry",
                          "Viable career path",
                          "Outsource")

datmm = datm %>%
    filter(!is.na(Choice))

#    theme(axis.text.x = element_blank(),
#          axis.ticks.x = element_blank(),
#          legend.position="bottom",
#          legend.title = element_blank(), 
#          legend.text=element_text(size=rel(0.7)),
#          legend.key.size = unit(.5, "cm"))

ggplot(datmm, aes(x= Q1.1, fill = Choice)) +
    facet_wrap("Question") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Q1.1, fill = Choice)) +
    facet_wrap("Question") +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

```{r}
datmm %>%
    group_by(Q1.1, Question, Choice) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1+ Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q7_4_g}
dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Researchers') %>%
    select(Gender, Q7.4_1, Q7.4_2, Q7.4_3, Q7.4_4, Q7.4_5, Q7.4_6)

datm = reshape2::melt(dat, id.vars = 'Gender', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Not at all important', 'Slightly important', 'Moderately important', 'Very important', 'Extremely important'))
datm$Question = factor(datm$Question)
levels(datm$Question) = c("Future staff",
                          "Underrepresented groups",
                          "Across disciplines",
                          "Competing with industry",
                          "Viable career path",
                          "Outsource")

datmm = datm %>%
    filter(!is.na(Choice))

#    theme(axis.text.x = element_blank(),
#          axis.ticks.x = element_blank(),
#          legend.position="bottom",
#          legend.title = element_blank(), 
#          legend.text=element_text(size=rel(0.7)),
#          legend.key.size = unit(.5, "cm"))

ggplot(datmm, aes(x= Gender, fill = Choice)) +
    facet_wrap("Question") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Gender, fill = Choice)) +
    facet_wrap("Question") +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

```{r}
datmm %>%
    group_by(Gender, Question, Choice) %>%
    tally() %>%
    left_join(tmp2, by = "Gender") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Gender+ Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q7_4_c}
dat = dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Researchers') %>%
    select(CareerStage, Q7.4_1, Q7.4_2, Q7.4_3, Q7.4_4, Q7.4_5, Q7.4_6)

datm = reshape2::melt(dat, id.vars = 'CareerStage', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Not at all important', 'Slightly important', 'Moderately important', 'Very important', 'Extremely important'))
datm$Question = factor(datm$Question)
levels(datm$Question) = c("Future staff",
                          "Underrepresented groups",
                          "Across disciplines",
                          "Competing with industry",
                          "Viable career path",
                          "Outsource")

datmm = datm %>%
    filter(!is.na(Choice))

#    theme(axis.text.x = element_blank(),
#          axis.ticks.x = element_blank(),
#          legend.position="bottom",
#          legend.title = element_blank(), 
#          legend.text=element_text(size=rel(0.7)),
#          legend.key.size = unit(.5, "cm"))

ggplot(datmm, aes(x= CareerStage, fill = Choice)) +
    facet_wrap("Question") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= CareerStage, fill = Choice)) +
    facet_wrap("Question") +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

```{r}
datmm %>%
    group_by(CareerStage, Question, Choice) %>%
    tally() %>%
    left_join(tmp3, by = "CareerStage") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ CareerStage+ Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

## In your opinion: How important were the following concerns when you were hired into your current position?

```{r fig12}
dat = dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Q1.1, Q7.5_1, Q7.5_2, Q7.5_3, Q7.5_4, Q7.5_5, Q7.5_6)

datm = reshape2::melt(dat, id.vars = 'Q1.1', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Not at all important', 'Slightly important', 'Moderately important', 'Very important', 'Extremely important'))
datm$Question = factor(datm$Question)
levels(datm$Question) = c("Diversity",
                          "Experience",
                          "Background",
                          "Diverse languages",
                          "Across disciplines",
                          "Growth")


datmm = datm %>%
    filter(!is.na(Choice))


ggplot(datmm, aes(x= Q1.1, fill = Choice)) +
    facet_wrap("Question") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Q1.1, fill = Choice)) +
    facet_wrap("Question") +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

```{r}
datmm %>%
    group_by(Q1.1, Question, Choice) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1+Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```


```{r Q7_5_g}
dat = dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Gender, Q7.5_1, Q7.5_2, Q7.5_3, Q7.5_4, Q7.5_5, Q7.5_6)

datm = reshape2::melt(dat, id.vars = 'Gender', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Not at all important', 'Slightly important', 'Moderately important', 'Very important', 'Extremely important'))
datm$Question = factor(datm$Question)
levels(datm$Question) = c("Diversity",
                          "Experience",
                          "Background",
                          "Diverse languages",
                          "Across disciplines",
                          "Growth")


datmm = datm %>%
    filter(!is.na(Choice))


ggplot(datmm, aes(x= Gender, fill = Choice)) +
    facet_wrap("Question") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Gender, fill = Choice)) +
    facet_wrap("Question") +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

```{r}
datmm %>%
    group_by(Gender, Question, Choice) %>%
    tally() %>%
    left_join(tmp2, by = "Gender") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Gender+Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```


```{r Q7_5_c}
dat = dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(CareerStage, Q7.5_1, Q7.5_2, Q7.5_3, Q7.5_4, Q7.5_5, Q7.5_6)

datm = reshape2::melt(dat, id.vars = 'CareerStage', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Not at all important', 'Slightly important', 'Moderately important', 'Very important', 'Extremely important'))
datm$Question = factor(datm$Question)
levels(datm$Question) = c("Diversity",
                          "Experience",
                          "Background",
                          "Diverse languages",
                          "Across disciplines",
                          "Growth")


datmm = datm %>%
    filter(!is.na(Choice))


ggplot(datmm, aes(x= CareerStage, fill = Choice)) +
    facet_wrap("Question") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= CareerStage, fill = Choice)) +
    facet_wrap("Question") +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

```{r}
datmm %>%
    group_by(CareerStage, Question, Choice) %>%
    tally() %>%
    left_join(tmp3, by = "CareerStage") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ CareerStage+Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

# Credit for Software Contributions

## When you write a paper and the work being described uses software, how often do you use each of the following approaches to mention the software? - Cite paper about the software

```{r fig14}
dat = dat_na %>%
    filter(!is.na(Q1.1)) %>%
    select(Q1.1, Q8.2_1, Q8.2_2, Q8.2_3, Q8.2_4, Q8.2_5, Q8.2_6, Q8.2_7)

datm = reshape2::melt(dat, id.vars = 'Q1.1', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Never', 'Sometimes', 'About half the timet', 'Most of the time', 'Always'))
datm$Question = factor(datm$Question, labels = c("Q8.2_1" = "Cite paper about the software",
                                                 "Q8.2_2" = "Cite the software user's manual",
                                                 "Q8.2_3" = "Mention the name of the software",
                                                 "Q8.2_4" = "Mention the URL of the software",
                                                 "Q8.2_5" = "Cite the URL of the software",
                                                 "Q8.2_6" = "Cite the published/archived software itself",
                                                 "Q8.2_7" = "Other"))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= Q1.1, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 40, hjust = .9, size = rel(.8)),
          legend.title = element_blank(),
          legend.position = 'bottom') #+ guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Q1.1, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = .9, size = rel(.8)),
          legend.title = element_blank(),
          legend.position = 'bottom')  
```

```{r}
datmm %>%
    group_by(Q1.1, Question, Choice) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1+Question) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q8_2_g}
dat = dat_na %>%
    filter(!is.na(Gender)) %>%
    select(Gender, Q8.2_1, Q8.2_2, Q8.2_3, Q8.2_4, Q8.2_5, Q8.2_6, Q8.2_7)

datm = reshape2::melt(dat, id.vars = 'Gender', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Never', 'Sometimes', 'About half the timet', 'Most of the time', 'Always'))
datm$Question = factor(datm$Question, labels = c("Q8.2_1" = "Cite paper about the software",
                                                 "Q8.2_2" = "Cite the software user's manual",
                                                 "Q8.2_3" = "Mention the name of the software",
                                                 "Q8.2_4" = "Mention the URL of the software",
                                                 "Q8.2_5" = "Cite the URL of the software",
                                                 "Q8.2_6" = "Cite the published/archived software itself",
                                                 "Q8.2_7" = "Other"))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= Gender, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 40, hjust = .9, size = rel(.8)),
          legend.title = element_blank(),
          legend.position = 'bottom') #+ guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Gender, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = .9, size = rel(.8)),
          legend.title = element_blank(),
          legend.position = 'bottom')  
```

```{r}
datmm %>%
    group_by(Gender, Question, Choice) %>%
    tally() %>%
    left_join(tmp2, by = "Gender") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Gender+Question) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

```{r Q8_2_c}
dat = dat_na %>%
    filter(!is.na(CareerStage)) %>%
    select(CareerStage, Q8.2_1, Q8.2_2, Q8.2_3, Q8.2_4, Q8.2_5, Q8.2_6, Q8.2_7)

datm = reshape2::melt(dat, id.vars = 'CareerStage', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Never', 'Sometimes', 'About half the timet', 'Most of the time', 'Always'))
datm$Question = factor(datm$Question, labels = c("Q8.2_1" = "Cite paper about the software",
                                                 "Q8.2_2" = "Cite the software user's manual",
                                                 "Q8.2_3" = "Mention the name of the software",
                                                 "Q8.2_4" = "Mention the URL of the software",
                                                 "Q8.2_5" = "Cite the URL of the software",
                                                 "Q8.2_6" = "Cite the published/archived software itself",
                                                 "Q8.2_7" = "Other"))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= CareerStage, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 40, hjust = .9, size = rel(.8)),
          legend.title = element_blank(),
          legend.position = 'bottom') #+ guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= CareerStage, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = .9, size = rel(.8)),
          legend.title = element_blank(),
          legend.position = 'bottom')  
```

```{r}
datmm %>%
    group_by(CareerStage, Question, Choice) %>%
    tally() %>%
    left_join(tmp3, by = "CareerStage") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ CareerStage+Question) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```
## How often do you currently receive the following types of credit for your software contributions?

```{r fig15}
dat = dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Q1.1, Q8.3_1, Q8.3_2, Q8.3_3, Q8.3_4, Q8.3_5, Q8.3_6)

datm = reshape2::melt(dat, id.vars = 'Q1.1', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Never', 'Sometimes', 'About half the timet', 'Most of the time', 'Always'))
datm$Question = factor(datm$Question, labels = c("Q8.3_1" = "(Co)author on research paper",
                                                 "Q8.3_2" = "(Co)author on software paper",
                                                 "Q8.3_3" = "Acknowledgment in paper",
                                                 "Q8.3_4" = "Software cited in a paper",
                                                 "Q8.3_5" = "Funded/hired to work on the software",
                                                 "Q8.3_6" = "Other"))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= Q1.1, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') #+ guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Q1.1, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  
```

```{r}
datmm %>%
    group_by(Q1.1, Question, Choice) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1+Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r Q8_3_g}
dat = dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(Gender, Q8.3_1, Q8.3_2, Q8.3_3, Q8.3_4, Q8.3_5, Q8.3_6)

datm = reshape2::melt(dat, id.vars = 'Gender', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Never', 'Sometimes', 'About half the timet', 'Most of the time', 'Always'))
datm$Question = factor(datm$Question, labels = c("Q8.3_1" = "(Co)author on research paper",
                                                 "Q8.3_2" = "(Co)author on software paper",
                                                 "Q8.3_3" = "Acknowledgment in paper",
                                                 "Q8.3_4" = "Software cited in a paper",
                                                 "Q8.3_5" = "Funded/hired to work on the software",
                                                 "Q8.3_6" = "Other"))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= Gender, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') #+ guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Gender, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  
```

```{r}
datmm %>%
    group_by(Gender, Question, Choice) %>%
    tally() %>%
    left_join(tmp2, by = "Gender") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Gender+Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r Q8_3_c}
dat = dat = dat_na %>%
    filter(Q1.1== 'Combination' | Q1.1 == 'Developers') %>%
    select(CareerStage, Q8.3_1, Q8.3_2, Q8.3_3, Q8.3_4, Q8.3_5, Q8.3_6)

datm = reshape2::melt(dat, id.vars = 'CareerStage', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Never', 'Sometimes', 'About half the timet', 'Most of the time', 'Always'))
datm$Question = factor(datm$Question, labels = c("Q8.3_1" = "(Co)author on research paper",
                                                 "Q8.3_2" = "(Co)author on software paper",
                                                 "Q8.3_3" = "Acknowledgment in paper",
                                                 "Q8.3_4" = "Software cited in a paper",
                                                 "Q8.3_5" = "Funded/hired to work on the software",
                                                 "Q8.3_6" = "Other"))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= CareerStage, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') #+ guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= CareerStage, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  
```

```{r}
datmm %>%
    group_by(CareerStage, Question, Choice) %>%
    tally() %>%
    left_join(tmp3, by = "CareerStage") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ CareerStage+Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```
## For your job role, does your institution allow software contributions to be considered in performance reviews or promotion cases?

```{r fig16}
dat_na$Q8.4 = ifelse(dat_na$Q8.4=='Dependent on the position (programmer vs. faculty)', 'Depends', dat_na$Q8.4)

dat_na$Q8.4 = factor(dat_na$Q8.4, levels = c('No', 'Depends', 'Yes'))

dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q8.4)) %>%
    select(Q1.1, Q8.4)



ggplot(dat, aes(x= Q1.1, fill = Q8.4)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') #+ guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(dat, aes(x= Q1.1, fill = Q8.4)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') 
```

```{r}
dat %>%
    group_by(Q1.1, Q8.4) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r}
urssi_analysis1(dat_na, x = "Gender", fill = "Q8.4")
```

```{r}
urssi_analysis2(dat_na, x = "Gender", fill = "Q8.4")
```

```{r}
urssi_analysis3(dat_na, x = "Gender", fill = "Q8.4")
```

```{r}

urssi_analysis1(dat_na, x = "CareerStage", fill = "Q8.4")
```

```{r}
urssi_analysis2(dat_na, x = "CareerStage", fill = "Q8.4")
```

```{r}
urssi_analysis3(dat_na, x = "CareerStage", fill = "Q8.4")
```

## How important do you believe software contributions are for your own performance review or promotion case?

```{r fig17}

dat_na$Q8.5 = factor(dat_na$Q8.5, levels = c('Not at all important', 'Slightly important', 'Moderately important', 'Very important', 'Extremely important'))

dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q8.5)) %>%
    select(Q1.1, Q8.5)



ggplot(dat, aes(x= Q1.1, fill = Q8.5)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(dat, aes(x= Q1.1, fill = Q8.5)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

```{r}
dat %>%
    group_by(Q1.1, Q8.5) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r}

urssi_analysis1(dat_na, x = "Gender", fill = "Q8.5")
```

```{r}
urssi_analysis2(dat_na, x = "Gender", fill = "Q8.5")
```

```{r}
urssi_analysis3(dat_na, x = "Gender", fill = "Q8.5")
```

```{r}

urssi_analysis1(dat_na, x = "CareerStage", fill = "Q8.5")
```

```{r}
urssi_analysis2(dat_na, x = "CareerStage", fill = "Q8.5")
```

```{r}
urssi_analysis3(dat_na, x = "CareerStage", fill = "Q8.5")

```

# Diversity/Inclusion

## How well does your project do the following

```{r fig18}
dat = dat_na %>%
    filter(!is.na(Q1.1)) %>%
    select(Q1.1, Q9.2_1, Q9.2_2, Q9.2_3, Q9.2_4)

datm = reshape2::melt(dat, id.vars = 'Q1.1', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Terrible', 'Poor', 'Average', 'Good', 'Excellent'))
datm$Question = factor(datm$Question, labels = c("Q9.2_1" = "Recruit participants from underrepresented groups",
                                                 "Q9.2_2" = "Retain participants from underrepresented groups",
                                                 "Q9.2_3" = "Include participants from underrepresented groups in governance and leadership positions",
                                                 "Q9.2_4" = "Maintain a culture of inclusion"))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= Q1.1, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 40)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') #+ guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Q1.1, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 40)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') 
```

```{r}
datmm %>%
    group_by(Q1.1, Question, Choice) %>%
    tally() %>%
    left_join(tmp, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1+Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r Q9_2_g}
dat = dat_na %>%
    filter(!is.na(Gender)) %>%
    select(Gender, Q9.2_1, Q9.2_2, Q9.2_3, Q9.2_4)

datm = reshape2::melt(dat, id.vars = 'Gender', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Terrible', 'Poor', 'Average', 'Good', 'Excellent'))
datm$Question = factor(datm$Question, labels = c("Q9.2_1" = "Recruit participants from underrepresented groups",
                                                 "Q9.2_2" = "Retain participants from underrepresented groups",
                                                 "Q9.2_3" = "Include participants from underrepresented groups in governance and leadership positions",
                                                 "Q9.2_4" = "Maintain a culture of inclusion"))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= Gender, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 40)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') #+ guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Gender, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 40)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') 
```

```{r}
datmm %>%
    group_by(Gender, Question, Choice) %>%
    tally() %>%
    left_join(tmp2, by = "Gender") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Gender+Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r Q9_2_c}
dat = dat_na %>%
    filter(!is.na(CareerStage)) %>%
    select(CareerStage, Q9.2_1, Q9.2_2, Q9.2_3, Q9.2_4)

datm = reshape2::melt(dat, id.vars = 'CareerStage', value.name = 'Choice', variable.name = 'Question')

datm$Choice = factor(datm$Choice, levels = c('Terrible', 'Poor', 'Average', 'Good', 'Excellent'))
datm$Question = factor(datm$Question, labels = c("Q9.2_1" = "Recruit participants from underrepresented groups",
                                                 "Q9.2_2" = "Retain participants from underrepresented groups",
                                                 "Q9.2_3" = "Include participants from underrepresented groups in governance and leadership positions",
                                                 "Q9.2_4" = "Maintain a culture of inclusion"))

datmm = datm %>%
    filter(!is.na(Choice))

ggplot(datmm, aes(x= CareerStage, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 40)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') #+ guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= CareerStage, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 40)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') 
```

```{r}
datmm %>%
    group_by(CareerStage, Question, Choice) %>%
    tally() %>%
    left_join(tmp3, by = "CareerStage") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ CareerStage+Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

## What are the challenges you face in creating / maintaining a culture of inclusion?

```{r Q9_3}

library(ggwordcloud)

x = dat_na %>%
    filter(!is.na(Q9.3)) %>%
    select(Q1.1, Gender, CareerStage, Q9.3) %>%
  tidytext::unnest_tokens(word, Q9.3) %>%
  anti_join(tidytext::get_stopwords()) %>%
  filter(!word%in%c("can", "always", "things"))

 set.seed(42)

 x %>%
  group_by(word) %>%
  tally() %>%
  filter(n>6) %>%
  ggplot(aes(label = word, size = n))  +
     geom_text_wordcloud_area(rm_outside = TRUE) +
  scale_size_area(max_size = 10) +
  theme_minimal() + 
   ggtitle("All Answers")
 
 
#x = x %>%
#  mutate(finding_underrepresented = str_detect(Q9.3, "underepresent"),
#         finding_people = str_detect(Q9.3, "finding"),
#         culture = str_detect(Q9.3, "culture"))



 x %>%
  group_by(Q1.1, word) %>%
  tally() %>%
  filter(n>2) %>%
  ggplot(aes(label = word, size = n))  +
     geom_text_wordcloud_area(rm_outside = TRUE) +
  scale_size_area(max_size = 10) +
  theme_minimal() + 
   facet_wrap(~Q1.1) + 
   ggtitle("Wordclouds by Q1.1")
 

dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q9.3)) %>%
    select(Q1.1, Q9.3)



datatable(dat, rownames = FALSE)

dat = dat_na %>%
    filter(!is.na(Gender) & !is.na(Q9.3)) %>%
    select(Gender, Q9.3)


 x %>%
  group_by(Gender, word) %>%
  tally() %>%
  filter(n>2) %>%
  ggplot(aes(label = word, size = n))  +
     geom_text_wordcloud_area(rm_outside = TRUE) +
  scale_size_area(max_size = 10) +
  theme_minimal() + 
   facet_wrap(~Gender) + 
   ggtitle("Wordclouds by Gender")


datatable(dat, rownames = FALSE)

dat = dat_na %>%
    filter(!is.na(CareerStage) & !is.na(Q9.3)) %>%
    select(CareerStage, Q9.3)

 x %>%
  group_by(CareerStage, word) %>%
  tally() %>%
  filter(n>2) %>%
  ggplot(aes(label = word, size = n))  +
     geom_text_wordcloud_area(rm_outside = TRUE) +
  scale_size_area(max_size = 10) +
  theme_minimal() + 
   facet_wrap(~CareerStage) + 
   ggtitle("Wordclouds by CareerStage")


datatable(dat, rownames = FALSE)
```

## Does your project do any measurement, tracking, or analysis of developer or user communities - with regard to diversity and/or inclusion?

```{r Q9_4}
dat = dat_na %>%
    select(Q1.1, Q9.4, Gender, CareerStage) %>%
  mutate(Q9.4 = tolower(Q9.4),
         answer = ifelse(str_detect(Q9.4, "no"),"No",
                         ifelse(str_detect(Q9.4, "yes"),"Yes", 
                            ifelse(str_detect(Q9.4, "n//?a"), NA,
                                   "Maybe")))) %>%
    mutate(answer = factor(answer,levels = c("Yes", "Maybe", "No")))
```

```{r}
   dat %>%
        select(answer) %>%
        filter(!is.na(answer) ) %>%
        group_by(answer) %>%
        tally() %>%
        mutate(N = sum(n),
               Proportion_of_Answered = percent(n/N)) %>%
        select(-c(N)) %>%
        flextable() %>%
        merge_v(j = ~ .) %>%
        autofit() %>%
        border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
        fix_border_issues()
```

```{r}
urssi_analysis2(dat, x= "answer", fill = "answer")

```

```{r}


#datatable(dat, rownames = FALSE)

urssi_analysis1(dat, x= "Q1.1", fill = "answer")
```

```{r}
urssi_analysis2(dat, x= "Q1.1", fill = "answer")
```

```{r}

urssi_analysis1(dat, x= "Gender", fill = "answer")
```

```{r}
urssi_analysis2(dat, x= "Gender", fill = "answer")
```

```{r}

urssi_analysis1(dat, x= "CareerStage", fill = "answer")
```

```{r}
urssi_analysis2(dat, x= "CareerStage", fill = "answer")


#datatable(dat, rownames = FALSE)
```


# Follow-up

### Are you willing to answer a few more questions about any of the following areas?
```{r Q10_1}
dat = dat_na %>%
    filter(!is.na(Q1.1)) %>%
    select(Q1.1, Q10.1)

dat$`Software Development Practices` = ifelse(str_detect(dat$Q10.1, 'Software Development Practices')==T,'Yes','No')
dat$`Development Infrastructure and Tools` = ifelse(str_detect(dat$Q10.1, 'Development Infrastructure and Tools')==T,'Yes','No')
dat$Training = ifelse(str_detect(dat$Q10.1, 'Training')==T,'Yes','No')
dat$`Funding / Institutional Support` = ifelse(str_detect(dat$Q10.1, 'Funding / Institutional Support')==T,'Yes','No')
dat$`Career Paths` = ifelse(str_detect(dat$Q10.1, 'Career Paths')==T,'Yes','No')
dat$`Credit for Software Contributions` = ifelse(str_detect(dat$Q10.1, 'Credit for Software Contributions')==T,'Yes','No')
dat$`Diversity / Inclusion` = ifelse(str_detect(dat$Q10.1, 'Diversity / Inclusion')==T,'Yes','No')


datm = reshape2::melt(dat[,-2], id.vars = 'Q1.1')
colnames(datm) = c('Q1.1', 'Areas', 'Willing')

datmm = datm %>%
        filter(!is.na(Willing))

ggplot(datmm, aes(x= Q1.1, fill = Willing)) +
    facet_wrap("Areas", labeller = label_wrap_gen(width = 25)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 40, hjust = .9, size = rel(.85)),
          legend.position = 'bottom',
          legend.title = element_blank())


ggplot(datmm, aes(x= Q1.1, fill = Willing)) +
    facet_wrap("Areas", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = .9, size = rel(.85)),
          legend.title = element_blank(),
          legend.position = 'bottom') 


tmp2 = datm %>%
  group_by(Q1.1, Areas) %>%
  filter(!is.na(Willing)) %>%
  tally()
```

```{r}
datmm %>%
    group_by(Q1.1, Areas, Willing) %>%
    tally() %>%
    left_join(tmp2, by = c("Q1.1", "Areas")) %>%
    mutate(Q1.1 = ifelse(Q1.1=="Combination", "Combination\nn=544",
                         ifelse(Q1.1=="Developers", "Developers\nn=89",
                                "Researchers\nn=473")),
             n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1+Areas) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()


```

## Software Development Practices Follow Up

### Maintenance is important for the long-term sustainability of a software project. For the following activities that are considered part of software maintenance, indicate what type of support you need for each activity
```{r Q11_1}
dat = dat_na %>%
    filter(Q1.1=='Combination' | Q1.1=='Developers') %>%
    select(Q1.1, Q11.1_1)

dat$Training = ifelse(str_detect(dat$Q11.1_1, 'Training')==T,'Needed','Not')
dat$Guidance = ifelse(str_detect(dat$Q11.1_1, 'Guidance')==T,'Needed','Not')
dat$Infrastructure = ifelse(str_detect(dat$Q11.1_1, 'Infrastructure')==T,'Needed','Not')


datm = reshape2::melt(dat[,c('Q1.1', 'Training', 'Guidance', 'Infrastructure')], id.vars = 'Q1.1')
datm$Question = 'Planning Maintenance'

datmm = datm

for(i in 1:5){
    
    dat = dat_na[ ,c('Q1.1', c('Q11.1_2', 'Q11.1_3', 'Q11.1_4', 'Q11.1_5', 'Q11.1_6')[i])] %>%
    filter(Q1.1=='Combination' | Q1.1=='Developers')

    dat$Training = ifelse(str_detect(dat[,2], 'Training')==T,'Needed','Not')
    dat$Guidance = ifelse(str_detect(dat[,2], 'Guidance')==T,'Needed','Not')
    dat$Infrastructure = ifelse(str_detect(dat[,2], 'Infrastructure')==T,'Needed','Not')
    
    
    datm = reshape2::melt(dat[,c('Q1.1', 'Training', 'Guidance', 'Infrastructure')], id.vars = 'Q1.1')
    datm$Question = c('Change tracking', 'Defect tracking', 
                      'Porting to new platforms', 'Configuration management', 'Regression testing')[i]
    
    datmm = rbind(datmm, datm)
    
}

datmmm = datmm %>%
        filter(value=='Needed') %>%
        select(variable, Question, Q1.1)

tmp3 = tmp2 %>%
  filter(Areas=="Software Development Practices") %>%
  select(-Areas)

ggplot(datmmm, aes(x= Q1.1, fill = variable)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())


ggplot(datmmm, aes(x= Q1.1, fill = variable)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') 
tmp3 = dat_na %>%
    filter(Q1.1=='Combination' | Q1.1=='Developers') %>%
    group_by(Q1.1) %>%
  tally()
```

```{r}
datmmm %>%
    group_by(Q1.1, Question, variable) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1+Question) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

### Overall, regardless of where you spend the most time, which of the following aspects of software development are more difficult than you think they should be?
```{r fig2}
dat = dat_na %>%
    filter(Q1.1=='Combination' | Q1.1=='Developers') %>%
    select(Q1.1, Q11.2)

dat$`Project\nManagement` = ifelse(str_detect(dat$Q11.2, 'Project management')==T,'Yes','No')
dat$`Requirements\nelicitation/engineering` = ifelse(str_detect(dat$Q11.2, 'Requirements elicitation / engineering')==T,'Yes','No')
dat$`Finding personnel/\nDeveloper turnover` = ifelse(str_detect(dat$Q11.2, 'Finding personnel / Developer turnover')==T,'Yes','No')
dat$Communication = ifelse(str_detect(dat$Q11.2, 'Communication (among those with different expertise, among different teams)')==T,'Yes','No')
dat$`Use of best practices vs.\nneed for rapid delivery` = ifelse(str_detect(dat$Q11.2, 'Use of best practices vs. need for rapid delivery')==T,'Yes','No')
dat$`Keeping up with\nmodern tools` = ifelse(str_detect(dat$Q11.2, 'Keeping up with modern tools')==T,'Yes','No')
dat$Porting = ifelse(str_detect(dat$Q11.2, 'Porting')==T,'Yes','No')
dat$Testing = ifelse(str_detect(dat$Q11.2, 'Testing')==T,'Yes','No')
dat$Debugging = ifelse(str_detect(dat$Q11.2, 'Debugging')==T,'Yes','No')
dat$Other = ifelse(str_detect(dat$Q11.2, 'Other')==T,'Yes','No')
dat$None = ifelse(str_detect(dat$Q11.2, 'None of the above')==T,'Yes','No')

datm = reshape2::melt(dat[,-2], id.vars = 'Q1.1')
colnames(datm) = c('Q1.1', 'Aspects', 'Difficult')


datmm = datm %>%
        filter(Difficult=='Yes')

ggplot(datmm, aes(x= Aspects, fill = Q1.1)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1, size = rel(.9)),
          legend.position = 'bottom',
          legend.title = element_blank())


ggplot(datmm, aes(x= Aspects, fill = Q1.1)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1, size = rel(.9)),
          legend.title = element_blank(),
          legend.position = 'bottom') 
tmp3 = dat_na %>%
    filter(Q1.1=='Combination' | Q1.1=='Developers') %>%
    group_by(Q1.1) %>%
  tally()
```

```{r}
datmm %>%
    group_by(Q1.1, Aspects) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()


```


### How often do you employ the following practices when developing software?
```{r Q11_3}
dat = dat_na %>%
    filter(Q1.1=='Combination' | Q1.1=='Developers') %>%
    select(Q1.1, Q11.3_1, Q11.3_2, Q11.3_3, Q11.3_4, Q11.3_5, Q11.3_6, Q11.3_7, Q11.3_8)

colnames(dat) = c('Profile', 'Requiremnts\ngathering', 'Software architecture\nor design', 
                 'Continuous\nIntegration', 'Pair programming', 'Waterfall', 
                 'Rational Unified Process', 'Peer code review', 'Coding standards')


datm = melt(dat, id.vars = 'Profile', value.name = 'Frequency', variable.name = 'Practice')

datmm = datm %>%
    filter(!is.na(Frequency))

datmm$Frequency = factor(datmm$Frequency , levels = c("Never", "Sometimes",
                                            "About half the time", "Most of the time",
                                            "Always"))

ggplot(datmm, aes(x = Profile, fill = Frequency)) +
    facet_wrap("Practice") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1, size = rel(.85)),
          legend.position = 'bottom',
          legend.title = element_blank()) 


ggplot(datmm, aes(x = Profile, fill = Frequency)) +
    facet_wrap("Practice") +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = 1, size = rel(.85)),
          legend.position = 'bottom',
          legend.title = element_blank())

tmp3 = dat_na %>%
    filter(Q1.1=='Combination' | Q1.1=='Developers') %>%
    group_by(Q1.1) %>%
  tally()
```

```{r}
datmm %>%
    group_by(Profile, Practice, Frequency) %>%
    tally() %>%
    left_join(tmp3, by = c("Profile"="Q1.1")) %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Profile+Practice) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()


```


### How often do you perform each of the following practices when developing software?
```{r Q11_4}
dat = dat_na %>%
    filter(Q1.1=='Combination' | Q1.1=='Developers') %>%
    select(Q1.1, Q11.4_1, Q11.4_2, Q11.4_3)

colnames(dat) = c('Profile', 'Develop a user\nmanual or online help', 
                 'Comment code', 'Use descriptive variables\n and method names')


datm = melt(dat, id.vars = 'Profile', value.name = 'Frequency', variable.name = 'Practice')

datmm = datm %>%
    filter(!is.na(Frequency))

datmm$Frequency = factor(datmm$Frequency , levels = c("Never", "Sometimes",
                                            "About half the time", "Most of the time",
                                            "Always"))

ggplot(datmm, aes(x = Profile, fill = Frequency)) +
    facet_wrap("Practice") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())


ggplot(datmm, aes(x = Profile, fill = Frequency)) +
    facet_wrap("Practice") +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())
```

```{r}
datmm %>%
    group_by(Profile, Practice, Frequency) %>%
    tally() %>%
    left_join(tmp3, by = c("Profile"="Q1.1")) %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Profile+Practice) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```


### How often do you document the following information when developing software?
```{r Q11_5}
dat = dat_na %>%
    filter(Q1.1=='Combination' | Q1.1=='Developers') %>%
    select(Q1.1, Q11.5_1, Q11.5_2, Q11.5_3, Q11.5_4)

colnames(dat) = c('Profile', 'Software\nrequirements', 
                 'User stories/\n use cases', 'Software architecture/\ndesign decisions', 'Test plan/\ntest goals')


datm = melt(dat, id.vars = 'Profile', value.name = 'Frequency', variable.name = 'Practice')

datmm = datm %>%
    filter(!is.na(Frequency))

datmm$Frequency = factor(datmm$Frequency , levels = c("Never", "Sometimes",
                                            "About half the time", "Most of the time",
                                            "Always"))

ggplot(datmm, aes(x = Profile, fill = Frequency)) +
    facet_wrap("Practice") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())


ggplot(datmm, aes(x = Profile, fill = Frequency)) +
    facet_wrap("Practice") +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())
```

```{r}
datmm %>%
    group_by(Profile, Practice, Frequency) %>%
    tally() %>%
    left_join(tmp3, by = c("Profile"="Q1.1")) %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Profile+Practice) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

## Development Infrastructure and Tools Follow Up

### Do you use use a version control system?
```{r Q12_1}
dat = dat_na %>%
    filter(Q1.1=='Combination' & !is.na(Q12.1)| Q1.1=='Developers' & !is.na(Q12.1)) %>%
    select(Q1.1, Q12.1)

tmp3 = tmp2 %>%
    filter(Areas=="Development Infrastructure and Tools") %>%
    select(-Areas)

ggplot(dat, aes(x = Q1.1, fill = Q12.1)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank()) 

ggplot(dat, aes(x = Q1.1, fill = Q12.1)) +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank()) 
```

```{r}
dat %>%
    group_by(Q1.1, Q12.1) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

### How often do you use each of the following for version control systems.
```{r Q12_2}
dat = dat_na %>%
    filter(Q1.1=='Combination' | Q1.1=='Developers') %>%
    select(Q1.1, Q12.2_1, Q12.2_2, Q12.2_3, Q12.2_4, Q12.2_5, Q12.2_6)

colnames(dat) = c('Profile', 'Git', 'SVN', 'Mercurial',
                  'Copying files to\nanother location', 'Zip file backups', 'Other')


datm = melt(dat, id.vars = 'Profile', value.name = 'Frequency', variable.name = 'System')

datmm = datm %>%
    filter(!is.na(Frequency))

datmm$Frequency = factor(datmm$Frequency , levels = c("Never", "Sometimes",
                                            "About half the time", "Most of the time",
                                            "Always"))

ggplot(datmm, aes(x = Profile, fill = Frequency)) +
    facet_wrap("System") +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())


ggplot(datmm, aes(x = Profile, fill = Frequency)) +
    facet_wrap("System") +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())

```

```{r}
datmm %>%
    group_by(Profile, System, Frequency) %>%
    tally() %>%
    left_join(tmp3, by = c("Profile"="Q1.1")) %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Profile+System) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
  

```

### On average, how frequently do you check-in or commit code to a version control system?
```{r Q12_3}
dat = dat_na %>%
    filter(Q1.1=='Combination' & !is.na(Q12.3) | Q1.1=='Developers' & !is.na(Q12.3)) %>%
    select(Q1.1, Q12.3)

dat$Q12.3 = factor(dat$Q12.3 , levels = c("After every change", "After a small group of changes",
                                            "After a major set of changes", "Never",
                                            "Other"))

ggplot(dat, aes(x = Q1.1, fill = Q12.3)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())


ggplot(dat, aes(x = Q1.1, fill = Q12.3)) +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}
dat %>%
    group_by(Q1.1, Q12.3) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

### Do you use continuous integration?
```{r Q12_4}
dat = dat_na %>%
    filter(Q1.1=='Combination' & !is.na(Q12.4) | Q1.1=='Developers' & !is.na(Q12.4)) %>%
    select(Q1.1, Q12.4)

dat$Q12.4 = factor(dat$Q12.4 , levels = c("Never", "Sometimes",
                                            "About half the time", "Most of the time",
                                            "Always"))

ggplot(dat, aes(x = Q1.1, fill = Q12.4)) +
    geom_bar(position="dodge") + 
    labs(x = '', y = 'Frequency') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())


ggplot(dat, aes(x = Q1.1, fill = Q12.4)) +
    geom_bar(position = 'fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}
dat %>%
    group_by(Q1.1, Q12.4) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

## Training Follow Up

### Please list any specific software-related training activities that you have found helpful (either the name, a link, or the topic).
```{r Q13_1}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q13.1)) %>%
    select(Q1.1, Q13.1)

#datatable(dat, rownames = FALSE)

activities = list(Carpentries=c("carpentr"),
                  hackathons = c("hackathon"),
                  meetups = c("meetup|mpi"),
                  courses = c("mooc|mitx|edx|coursera|courses|codeacademy|class|lynda"),
                  online_help = c("xsede|youtube|forum|consultation"),
                  workshop = c("workshop|bootcamp|sage days"))


dat = lapply(activities, FUN = function(x) str_detect(tolower(dat$Q13.1), x)) %>%
  cbind(dat)

dat1 = dat %>%
  select(-Q13.1) %>%
  melt(id="Q1.1", variable.name="activity") %>%
  filter(value==T)

ggplot(dat1, aes(x = activity, fill = activity)) +
    geom_bar(position = 'dodge') + 
    labs(x = '', y = 'Count') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}
   dat1 %>%
        group_by(!! sym("Q1.1"), !! sym("activity")) %>%
        tally() %>%
        flextable() %>%
        merge_v(j = ~ .) %>%
        autofit() %>%
        border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
        fix_border_issues()

```

### What software-related topics would you or your team like to receive training about?
TODO
```{r Q13_2}

ggthemr_reset()
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q13.2)) %>%
    select(Q1.1, Q13.2) %>%
  filter(!Q13.2%in%c("N/A","None at this time"))


dat = dat %>%
  mutate(Q13.2=ifelse(Q13.2=="How to use Python in the context of HPC?  The Python language itself is not so much of an issue as how to use Python core in concert with the plethora of modules.  The infrastructure of this system is totally confusing.  The Python 2 versus Python 3 problem is such a waste of time.  Python is free so it's here for good, but MATLAB which Python is kind of trying to emulate was much more stable and dependable.\n\nGithub training that I have experience was not taught well.  It is a very confusing system so it requires a really good teacher to provide knowledge that can be used.  Rick Umali's book is fantastic, but that's a lot of time.  People at my institution and computer scientists with MS degrees cannot easily use this important system.",
       "Python", 
ifelse(Q13.2=="We need more help on testing and integration frameworks. ",
       "testing,integration frameworks",
ifelse(Q13.2=="Preservation and sharing of code (and data) for reproducibility.",
       "reproducibility",
ifelse(Q13.2=="Continuous education on emerging software engineering tools and practices applicable to research software. There is a lot out there that are constantly emerging.", 
       "research tools,best practices",
ifelse(Q13.2=="Use of modern C++ features, debugging, build systems.",
       "C++,debugging,build systems",
ifelse(Q13.2=="Annotation of software other than description of the numeric and computational aspects. For example, what is the end use of the piece of code? Does is represent a biological cell or a building structural element? Can the key aspects of the system being modeled be extracted from the code? ",
       "documentation",
ifelse(Q13.2=="Using/accessing large data sets for equity analysis ",
       "big data",
ifelse(Q13.2=="good practices in software development and associated open-access tools",
       "best practices,research tools",
ifelse(Q13.2=="Anything that would make it easier for PhD students to contribute/pick up a project. My fear is that once my current PhD student finishes no one will be able to understand and pick up his project.",
       "reproducibility",
ifelse(Q13.2=="Develop for longevity and flexibility. Best practice for encouraging documentation. Technology for active user manuals and tutorials.",
       "reproducibility,best practices,documentation",
ifelse(Q13.2=="language-specific courses\nmachine-learning",
       "language-specific courses,machine-learning",
ifelse(Q13.2=="I am almost entirely self-taught, so I would benefit from using more regularlized techniques to manage projects and to do more rational testing of my code.",
           "testing",
ifelse(Q13.2=="Python programing. Parallel computing.",
       "Python, parallel computing.",
ifelse(Q13.2=="Project management \nSoft skills to retain and keep team motivated ",
       "project management",
ifelse(Q13.2=="We regularly find ourselves fumbling around using various software and webservers related to protein sequence analyses and data mining.\n\nAlso, as novices occasionally developing small codes for specialized purposes - what are the best practices to release and curate such code in a way that is useful for other potential users.",
       "best practices, research tools",
ifelse(Q13.2=="Architecture and software engineering. Students have been trained in languages but not in building, testing, maintaining software.",
       "software engineering,reproducibility",
ifelse(Q13.2=="Use of Unix-based software (containers, Virtual machines, etc.), installation and dependency management;  Github",
       "unix,Github",
ifelse(Q13.2== "Software project management and repository management. It is often unclear how we should manage versions, who should be responsible for what task, etc. In addition, even if the roles and processes were defined, we need to be trained on the tools themselves.",
       "project management",
ifelse(Q13.2== "Basic programming skills for non-computational biomedical scientists",
       "basic programming",
ifelse(Q13.2== "How to modify/customize certain software.",
       "research tools",
ifelse(Q13.2== "How to develop software for medical devices (best practices, FDA regulations, ...)",
       "software development,best practices",
ifelse(Q13.2== "I would love for my team to be better a project management, but it is not a priority.",
       "project management",
ifelse(Q13.2== "software development best practices for researchers.",
       "best practices",
ifelse(Q13.2== "TDD (Test-driven development)\nRegression testing\nSoftware architecture planning",
       "testing,regression,software architecture planning",
ifelse(Q13.2== "Free to use continuous integration platforms including TravisCI, CircleCI, AppVeyor.\n\nFree to use documentation platforms like Read The Docs.",
       "research tools",
ifelse(Q13.2== "I don't want to receive training about these, but I would like there to be more training material, in general, about, well, \"data science\": the theory and practice of data analysis in the glorious, messy world out there. It turns out that many of the topics that data science education tackles also happen in the small (eg within a lab run by junior faculty, which is my case). Incoming students rarely have the training necessary to be productive right away, and we expect them to do so. That's unfair on the students, especially as we the community lacks a good set of practices.",
       "data science",
ifelse(Q13.2=="Defensive programming; error and bounds checking; libraries of tests for numerical stability; methods of using revision control (and not just Git); project planning from the bottom up (i.e., training to see the project from the perspective of those tasked with implementation); choosing sane performance 'metrics' that do not encourage managerial 'gaming' of the system(s).",
       "defensive programming,testing,project management,data science",
ifelse(Q13.2=="Maintainable software engineering / design, specific to C++.",
       "C++",
ifelse(Q13.2=="RNA-seq, ChIP-seq, ATAC-seq, Hi-C, Exome-seq, Clinical online tools", "research tools", Q13.2))))))))))))))))))))))))))))))

dat_test = dat[-1,] %>%
  mutate(Q13.2 = tolower(Q13.2))


a = dat_test %>%
  filter(!str_detect(dat_test$Q13.2, ","))

tc = dat_test %>%
  filter(str_detect(dat_test$Q13.2, ","))

b= str_split(tc$Q13.2,pattern=",", simplify = T) %>%
  as.data.frame() %>%
   cbind(Q1.1=tc$Q1.1)

Q13.2 = melt(b, id="Q1.1", value.name="Q13.2") %>%
  select(-variable) %>%
  rbind(a) %>%
  mutate(topics = trimws(Q13.2)) %>%
  select(-Q13.2) %>%
  filter(topics!="" &!is.na(topics))

rm(a);rm(b); rm(tc); rm(dat_test)

Q13.2= Q13.2 %>%
  mutate(topics = ifelse(topics%in%c("statistical analysis", "machine-learning", "regression", "deep learning", "data science"), "analysis",
                  ifelse(topics%in%c("hpc", "parallel computing", "parallel computing.", "massive distributed computing"),
                                     "parallel computing",
                  ifelse(topics%in%c("cmake", "openmpi", "networking and mpi", "gitlab ci/cd", "github"),
                                     "research tools",
                  ifelse(topics%in%c("basic programming", "c++", "gitlab ci/cd", "python", "unix", "r/bioconductor", "programming language overviews", "matlab"),
                                     "language-specific courses" ,
                  ifelse(topics%in%c("integration frameworks", "software development", "software architecture", "software architecture planning", "build systems", "gpu", "unit testing", "testing", "cluster maintenance", "testing practices", "queueing systems", "porting to new systems"),
                                     "software engineering/dev",
                  ifelse(topics=="graphics.", "graphics", topics
)))))))

tmp = Q13.2 %>%
  group_by(topics) %>%
  tally() %>%
  filter(n>1) %>%
  select(topics)

Q13.2%>%
  filter(topics%in%tmp$topics) %>%
ggplot(aes(x = topics, fill = topics)) +
    geom_bar(position = 'dodge', show.legend = F) + 
    labs(x = '', y = 'Count') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank())
```

```{r}
   Q13.2 %>%
        group_by(!! sym("Q1.1"), !! sym("topics")) %>%
        tally() %>%
        flextable() %>%
        merge_v(j = ~ .) %>%
        autofit() %>%
        border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
        fix_border_issues()
```

```{r}
datatable(dat, rownames = FALSE)
```

## Funding Institutional Support Follow Up

### In general, do you think you have sufficient funding to support software development activities in your research?
```{r fig9}
dat = dat_na %>%
    filter(Q1.1 == "Combination" & !is.na(Q14.2)| Q1.1 == "Developers" & !is.na(Q14.2)) %>%
    select(Q1.1, Q14.2)

tmp3 = tmp2 %>%
    filter(Areas=="Funding / Institutional Support") %>%
    select(-Areas)

dat$Q14.2 = factor(dat$Q14.2, levels = c("Insufficient and creates barrier to my work", "2", "3", "4", "Sufficient to do my work"))

ggplot(dat, aes(x= Q14.2, fill = Q1.1)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank()) +
    scale_x_discrete(drop = F, labels = c("Insufficient and\n creates barrier\n to my work", "2", "3", "4", "Sufficient to do\n my work"))


ggplot(dat, aes(x= Q14.2, fill = Q1.1)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    scale_x_discrete(drop = F, labels = c("Insufficient and\n creates barrier\n to my work", "2", "3", "4", "Sufficient to do\n my work"))
```

```{r}
dat %>%
    group_by(Q1.1, Q14.2) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit() %>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

### In particular, how well does your current funding support the following activities?
```{r Q14_3}
dat = dat_na %>%
    filter(!is.na(Q1.1)) %>%
    select(Q1.1, Q14.3_1, Q14.3_2, Q14.3_3)

datm = reshape2::melt(dat, id.vars='Q1.1', variable.name = 'Question', value.name ='Choice' )

datmm = datm %>%
    filter(!is.na(Choice))

datmm$Question = factor(datmm$Question, labels = c("Q14.3_1" = "Developing new software",
                                                   "Q14.3_2" = "Modifying or reusing existing software",
                                                   "Q14.3_3" = "Maintaining software"))

datmm$Choice = factor(datmm$Choice, levels = c("Insufficient and creates barrier to my work", "2", "3", "4", "Sufficient to do my work"))

ggplot(datmm, aes(x= Choice, fill = Q1.1)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1, size = rel(.8)),
          legend.position = 'bottom',
          legend.title = element_blank()) +
    scale_x_discrete(drop = F, labels = c("Insufficient and\n creates barrier\n to my work", "2", "3", "4", "Sufficient to do\n my work"))


ggplot(datmm, aes(x= Choice, fill = Q1.1)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    scale_x_discrete(drop = F, labels = c("Insufficient and\n creates barrier\n to my work", "2", "3", "4", "Sufficient to do\n my work"))
```

```{r}
datmm %>%
    group_by(Q1.1, Question, Choice) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1+Question) %>%
    autofit()%>%
    border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

### If you develop new software, does your current funding support the following activities
```{r Q14_4}
dat = dat_na %>%
    filter(Q1.1 == "Combination" | Q1.1 == "Developers") %>%
    select(Q1.1, Q14.4_1, Q14.4_2, Q14.4_3, Q14.4_4, Q14.4_5)


datm = reshape2::melt(dat, id.vars='Q1.1', variable.name ='Question', value.name='Choice')

datmm = datm %>%
    filter(!is.na(Choice))

datmm$Question = factor(datmm$Question, labels = c("Q14.4_1" = "Refactoring",
                                                   "Q14.4_2" = "Testing",
                                                   "Q14.4_3" = "Creating or updating documentation",
                                                   "Q14.4_4" = "Responding to issues/ bugs reported by community of users",
                                                   "Q14.4_5" = "Developing new features/ functionality"))

datmm$Choice = factor(datmm$Choice, levels = c("Insufficient and creates barrier to my work", "2", "3", "4", "Sufficient to do my work"))

ggplot(datmm, aes(x= Choice, fill = Q1.1)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 40), dir = 'v') +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 40, hjust = .85, size = rel(.8)),
          legend.position = 'bottom',
          legend.title = element_blank()) +
    scale_x_discrete(drop = F, labels = c("Insufficient\n and creates\n barrier to my work", "2", "3", "4", "Sufficient to do\n my work"))


ggplot(datmm, aes(x= Choice, fill = Q1.1)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 40), dir ='v') +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 40, hjust = .85, size = rel(.8)),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    scale_x_discrete(drop = F, labels = c("Insufficient\n and creates\n barrier to my work", "2", "3", "4", "Sufficient to do\n my work"))
```

```{r}
datmm %>%
    group_by(Q1.1, Question, Choice) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1+Question) %>%
    autofit()%>%
    border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```


### The biggest financial burdens I face in using or developing software for my research are:
```{r Q14_5}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q14.5)) %>%
    select(Q1.1, Q14.5)


Q14.5 = dat %>%
    mutate(burdens = ifelse(Q14.5=="Release time to acquire both new programming skills/techniques and time to acquire base levels of domain knowledge.  My institution seems to think we can provide good systems and research software support with junior system administrators and only a handful of people who don't work together.  Revisiting and revitalizing the idea of a 'computing center' where real people who use computers can get consulting, high-end equipment that is beyond the budget of one group, and get coffee and find sociability and other collaborators.  That would countervail fragmentation into the library, into departments or domain specific centers, all of which seems to promote monocultures of expertise (or the lack thereof).", 
                            "continued education",
ifelse(Q14.5%in%c("Convincing funding agencies that software is like dishes: It is only done if you never intend to use it again. Agencies want the newest and best. But do no understand we need time ($) to maintain very popular and KEY software. In addition it is hard/impossible to convince many agencies to fund contributions to large community projects (Scipy) Agencies like branding. ", "Lack of staff/personnel to build, maintain, update open source software packages.
Lack of staff/personnel to do training for researchers who require said packages.", "Everyone cares about the research outcomes; no one seems to care about usability, maintainability, and extensibility.", "Funding is never set aside for maintenance.", "Revenue for maintaining our highly successful code base. ", "lack of funding for maintenance of already written software, I have to cannibalize funds for development to support maintenance", "It's almost impossible to get funding to maintain a computational software (at least at the scale I do research) and very difficult to get funding for projects mostly focusing on computational aspect (which require a lot of coding). It seems getting funding on developing computational methods becomes more difficult year by year.", "The one aspect that, to my knowledge, NO funding agency ever addresses is what they really mean by \"sustainable\".  Giving a PI a 3-year grant, with no stated intent of renewal, is the exact opposite of sustainable.  If funding agencies are truly interested in sustainable software, they would (a) offer some semblance of a continuous funding source, and (b) fund infrastructure, such as computing clusters, for ongoing maintenance and testing.  Scientific software, in particular, often requires very large calculations and testing/maintenance thereof.  ", "Funding ongoing maintenance","support after completion of a grant.", "Conviencing funding agencies to fund development work related to optimization and portability of current software.", "Our funding, and that of everyone else in my discipline, typically is directed at answering scientific questions. Software is something we develop as a by-product. The software is not generally wonderfully designed at that point, and when the project is completed, the support ends, so maintenance is a nightmare. ", "Maintenance is a tax on software development, not a funded activity in its own right.", "Lack of long-term institutional support of maintaining infrastructure.", "There is absolutely no support for maintenance, yet the funding agencies demand that the software be open source which establishes hurdles to using the commercial model to support maintenance and infrastructure costs.", "The development of new software is almost always necessary for most research projects, and funding for this is provided implicitly in the budget for students and post-docs.
But software maintenance is something that is most often forgotten or ignored. As technology changes, at our institute we are facing the problem of needing to shut down valuable databases due to obsolescence of hardware/software platform.", "The NIH generally is not interested in supporting software development- they are interested in answering clinical questions or generating new science, and while software can be spun as a necessary tool along the way, we have had very little luck writing proposals that have  software development as an actual goal of the project. Similarly, once a grant is over, there's no money for maintenance, continued hosting or computational resources, etc., which means that just at the point that you've built a tool to the level of being useful, the rug gets pulled out from you in terms of supporting that tool."),
       "maintenance",
ifelse(Q14.5%in%c("General salary is not competitive at all with industry, retention is an issue.", "I think the issue is a balance between finding the personnel and funding. For example, we need 10% this or 25% that but cannot rationally fund a whole person if we could find them.  A RSE group would help as it could leverage expertise across projects. So I am thinking  there is a critical mass of projects, people and funding necessary.", "funding for personnel", "Paying people.", "Not enough money to hire post-docs skilled in programming.
Too few chemistry graduate students with any programmings skills or interests", "finding and funding PhD students", "Keeping top talent.", "Salary costs","Funding for personnel ","Paying for skilled labor/trainees", "Paying high enough salaries to attract programmers.", "Budgeting for a full-time programmer is hard for NSF grants", "sustainability. It is hard to pay my salary on grants alone. overhead at UC is too high.", "my salary (soft money position), paid developers", "Paying for software consultants for software development and maintenance of existing software and server access and service support", "Retaining top talent in a competitive market and/or dealing with turnover.", "Supporting part time developers and developers on a project-specific basis. Hiring full-time developers who can focus on maintaining projects", "Training physics students in learning to code."),
       "personnel",
ifelse(Q14.5%in%c("Funds for committed time","Limited grant funding", "Software funding schemes are so incredibly oversubscribed. One has to write a nearly perfect proposal and still the odds are bad. Most funding schemes are incapable of providing full support to a research software person, so you have to write multiple perfect proposals. And now, institutions like the NSF are capping the number of proposals on which someone can serve as PI or coPI, so now you cannot even submit enough proposals to fund yourself. Full soft-money research/software positions in certain fields are almost literally impossible at this point.", "writing proposals and getting them funded", "Convincing external funding agencies that it aligns with their missions", "Having any money", "Getting funding.", "Finding on-going funding to support my full salary to continue to support and expand research software that is being cited over 700 / year and downloaded ~ 20,000 per year.", "Getting any money at all to develop software in pure mathematics.", "Getting the money", "Finding support for people to do the work.", "Uncertainty about future funding for development",  "Software simply doesn't count and is largely bootstrapped off of projects resulting in most cases lousy code. ", "I have found software use and development to be consistently underfunded. The University seems to think it should be supported entirely by extramural funds, and NSF seems to think it should be supported entirely by the University. We just have to make do as best we can.", "Finding a steady source of funding to support professional software developers, especially since they are expensive.   Also, getting postdocs to do software development is not always successful because they need to place more emphasis on research publications.   ", "Lack of funding.", "Complete lack of funding from external sources, even though the community tells me at conferences that they love my work and I should be funded.", "slim budget for the projects", "None of my existing open source tools have any explicit funding", "Developing software just 'eats up' research funds -- so we are always torn between how much time to spend on each.", "None of these categories are supported by grants!  We manage to get along only by license income. I and my teammates also do some of this in our spare time, like writing manual on vacation. ", "funding and institutional support. ", "Funding to develop new software packages is nonexistent at small liberal arts colleges.", "Funding agencies do not support software development in computer science", "There is little incentive in existing programs beyond the fundamental knowledge. Instead, I have to go to outside programs for fuerther development.", "Review panels do not want to fund new software development in biological sciences. The projects are too interdisciplinary. Program officers will not fund 50/50 software dev/wetlab projects that are needed to test and improve software to take it to the next level. On the biological side reviewers are prohibitively skeptical of software output or development efforts.", "Just in general. I am the one having both the coding ideas required and the science cases where I want to apply them. The current funding infrastructure doesn't easily allow me to be both a developer and a researcher.", "Red tape and paperwork in charging software to federal grants.  ", "Grant writing and competition for funds to develop research software."),
       "limited funding",
ifelse(Q14.5%in%c("I am funded to do research and the software I develop is a means to an end, not the end in itself. Hence, I constantly have to squeeze time for the software out of time I need to spend on domain research science.","My funding and progress have nothing regarding the software development which is the major part of the research. So developing a good software with document and unit test and etc has no support in my current funding.","Funding the organizational infrastructure that supports it.", "Time spent on other activities", "It's almost all time and personnel limitations (not enough time, not enough people who are willing to work on the project and have the necessary skills to do so) rather than money limitations.", "Acquisition time-lines\n\"Color of Money\" issues - Which money can be spent on what.\nSire Licensing complexities", "Affording the time necessary to properly maintain this when working at a teaching-focused university.", "To fund my position I am spread too thin between too many projects, so do not have enough time for any one of them.", "My time is expensive.  I only have enough to do the science, not to plan, document, and release software.", "It's not about money - my faculty salary is extremely generous. It's really about time (and credit) allocation. Software development takes *time*. To be perfectly frank, as a currently untenured faculty, it's on my best interest to invest time on whatever I think my tenure letter writers will consider worthy of positive mention. Currently, software development is not those categories. So it's too risky for me to jeopardize my future career by sinking massive amounts of time in software development."),
       "lack of time",
ifelse(Q14.5%in%c("Unexpected announcements to purchase upgrades.", "License fees
-adjustments by the company for various programs we are using the software for", "Lack of cloud infrastructure for running experiments", "cost of software", "institutional infrastructure", "Complexity/heterogeneity of research computing environment."), 
       "infrastructure and software", "Other")))))))

ggplot(Q14.5, aes(x= burdens, fill = Q1.1)) +
    geom_bar(position='dodge') + 
    labs(x = '', y = 'Count') +
    theme(axis.text.x = element_text(angle = 40, hjust = .85, size = rel(.8)),
          legend.title = element_blank(),
          legend.position = 'bottom')
```

```{r}
Q14.5 %>%
    group_by(Q1.1, burdens) %>%
    tally() %>%
    flextable() %>%
    merge_v(j = ~ .) %>%
    autofit()%>%
    border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

```{r}
datatable(dat, rownames = FALSE)
```

### If you were given a budget of $100 million to support research software development and maintenance in the USA how would you choose to spend it (i.e. to which types of activities would you allocate money and how much)? Please allocate your budget in millions of dollars.  Responses need to total to $100.
```{r Q14_6}
dat = dat_na %>%
    filter(!is.na(Q1.1)) %>%
    select(Q1.1, Q14.6_1, Q14.6_2, Q14.6_3, Q14.6_4, Q14.6_5, Q14.6_6, Q14.6_7, Q14.6_8, Q14.6_9, Q14.6_10)

datm = reshape2::melt(dat, id.var='Q1.1', value.name ='Amount', variable.name = 'Activity')

datmm = datm %>%
        filter(!is.na(Amount))

datmm$Amount = as.numeric(as.character(datmm$Amount))

datmm$Activity = factor(datmm$Activity, labels = c("Q14.6_1" = "Project\n management",
                                                   "Q14.6_2" = "Requirements\n elicitation / engineering",
                                                   "Q14.6_3" = "Finding personnel",
                                                   "Q14.6_4" = "Communication",
                                                   "Q14.6_5" = "Use of best practices",
                                                   "Q14.6_6" = "Rapid development",
                                                   "Q14.6_7" = "Porting",
                                                   "Q14.6_8" = "Testing",
                                                   "Q14.6_9" = "Debugging",
                                                   "Q14.6_10" = "Other"))

ggplot(datmm, aes(x = Activity, y = Amount, fill = Q1.1)) +
    geom_boxplot(fatten = NULL, outlier.size = .5) +
    stat_summary(fun = mean, geom = "errorbar",
                 aes(ymax = ..y.., ymin = ..y..),
                 width = .75, linetype = "solid", position = "dodge", color = "black") +
    labs(title = NULL, x = NULL, y = 'Amount ($)',
         caption = "Middle line indicates mean.") +
    theme(axis.text.x = element_text(angle = 30, hjust = 1, size = rel(.8)),
          legend.position = 'bottom',
          legend.title = element_blank()) 
```

```{r}
datmm %>%
  group_by(Q1.1, Activity) %>%
  summarize(mean = round(mean(Amount),2), sd = round(sd(Amount),2)) %>%
  flextable() %>%
  merge_v(j = ~ Q1.1) %>%
  autofit()%>%
  border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

## Career Path Follow Up

### Do other members of your organization or institution use your software?

```{r Q15_1}
dat = dat_na %>%
    filter(Q1.1 == "Combination" & !is.na(Q15.1) | Q1.1 == "Developers" & !is.na(Q15.1)) %>%
    select(Q1.1, Q15.1)

tmp3 = tmp2 %>%
    filter(Areas=="Career Paths") %>%
    select(-Areas)

ggplot(dat, aes(x= Q1.1, fill = Q15.1)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())


ggplot(dat, aes(x= Q1.1, fill = Q15.1)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') 
```

```{r}
dat %>%
    group_by(Q1.1, Q15.1) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit() %>%
    border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

### Have other members of your organization contacted you about developing software for them?

```{r Q15_2}
dat = dat_na %>%
    filter(Q1.1 == "Combination" & !is.na(Q15.2) | Q1.1 == "Developers" & !is.na(Q15.2)) %>%
    select(Q1.1, Q15.2)


ggplot(dat, aes(x= Q1.1, fill = Q15.2)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())


ggplot(dat, aes(x= Q1.1, fill = Q15.2)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') 
```

```{r}
dat %>%
    group_by(Q1.1, Q15.2) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit() %>%
    border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()

```

### Rate the importance of each of the following factors when deciding upon accepting a new job position or promotion.

```{r fig13}
dat = dat_na %>%
    filter(Q1.1 == "Combination" | Q1.1 == "Developers") %>%
    select(Q1.1, Q15.3_1, Q15.3_2, Q15.3_3, Q15.3_4, Q15.3_5, Q15.3_6)

datm = reshape2::melt(dat, id.vars='Q1.1', value.name='Choice', variable.name='Question')

datmm = datm %>%
        filter(!is.na(Choice))

datmm$Question = factor(datmm$Question, labels = c("Q15.3_1" = "Title of the position",
                                                   "Q15.3_2" = "Salary raise",
                                                   "Q15.3_3" = "Responsibilities for a project or parts of a project",
                                                   "Q15.3_4" = "Leading a team",
                                                   "Q15.3_5" = "Available resources such as travel money",
                                                   "Q15.3_6" = "Other"))

datmm$Choice = factor(datmm$Choice, levels = c("Extremely important",
                                               "Very important",
                                               "Moderately important",
                                               "Slightly important",
                                               "Not at all important"))

ggplot(datmm, aes(x= Q1.1, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank()) + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(datmm, aes(x= Q1.1, fill = Choice)) +
    facet_wrap("Question", labeller = label_wrap_gen(width = 25)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

```{r}
datmm %>%
    group_by(Q1.1, Question, Choice) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1+Question) %>%
    autofit()%>%
    border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

## Credit for Software Follow Up

### If you use open source software not developed by you, how important is the number of downloads for your decision to use it?

```{r Q16_1}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q16.1)) %>%
    select(Q1.1, Q16.1) %>%
    mutate(Q16.1 = factor(Q16.1, levels = c("Extremely important",
                                               "Very important",
                                               "Moderately important",
                                               "Slightly important",
                                               "Not at all important")))

tmp3 = tmp2 %>%
    filter(Areas=="Credit for Software Contributions") %>%
    select(-Areas)

ggplot(dat, aes(x= Q1.1, fill = Q16.1)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank()) +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(dat, aes(x= Q1.1, fill = Q16.1)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

```{r}
dat %>%
    group_by(Q1.1, Q16.1) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit() %>%
    border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

### If you use open source software not developed by you, how important is the number of contributors for your decision to use it?

```{r Q16_2}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q16.2)) %>%
    select(Q1.1, Q16.2) %>%
    mutate(Q16.2 = factor(Q16.2, levels = c("Extremely important",
                                               "Very important",
                                               "Moderately important",
                                               "Slightly important",
                                               "Not at all important")))
ggplot(dat, aes(x= Q1.1, fill = Q16.2)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank()) +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(dat, aes(x= Q1.1, fill = Q16.2)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

```{r}
dat %>%
    group_by(Q1.1, Q16.2) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit() %>%
    border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

### If you use open source software not developed by you, how important is the presence of an academic publication about the software for your decision to use it?

```{r Q16_3}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q16.3)) %>%
    select(Q1.1, Q16.3) %>%
    mutate(Q16.3 = factor(Q16.3, levels = c("Extremely important",
                                               "Very important",
                                               "Moderately important",
                                               "Slightly important",
                                               "Not at all important")))


ggplot(dat, aes(x= Q1.1, fill = Q16.3)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank()) +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))


ggplot(dat, aes(x= Q1.1, fill = Q16.3)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

```{r}
dat %>%
    group_by(Q1.1, Q16.3) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit() %>%
    border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

## Diversity and Inclusion Follow Up

### Considering the software project that you spend the most time working on, does this project have a diversity / inclusion statement or policy?

```{r fig19}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q17.1)) %>%
    select(Q1.1, Q17.1)

tmp3 = tmp2 %>%
    filter(Areas=="Diversity / Inclusion") %>%
    select(-Areas)

dat$Q17.1 = factor(dat$Q17.1, levels = c('Yes', 'No, but we plan to develop one', 'No, and we do not plan to develop one', 'Other'))

ggplot(dat, aes(x= Q17.1, fill = Q1.1)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())


ggplot(dat, aes(x= Q17.1, fill = Q1.1)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') 
```

```{r}
dat %>%
    group_by(Q1.1, Q17.1) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit() %>%
    border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

### You responded that the software project that you spend the most time working on has a diversity / inclusion statement or policy.  In the box below, please provide a link to that statement or policy.

```{r Q17_2}
dat = dat_na %>%
    filter(Q1.1 == "Combination" & !is.na(Q17.2) | Q1.1 == "Developers" & !is.na(Q17.2)) %>%
    select(Q1.1, Q17.2)



datatable(dat, rownames = FALSE)
```

### Considering the software project that you spend the most time working on or with, does this project have a code of conduct?

```{r fig20}
dat = dat_na %>%
    filter(Q1.1 == "Combination" & !is.na(Q17.3) | Q1.1 == "Developers" & !is.na(Q17.3)) %>%
    select(Q1.1, Q17.3)


dat$Q17.3 = factor(dat$Q17.3, levels = c('Yes', 'No, but we plan to develop one', 'No, and we do not plan to develop one', 'Other'))

ggplot(dat, aes(x= Q17.3, fill = Q1.1)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank())


ggplot(dat, aes(x= Q17.3, fill = Q1.1)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom') 
```

```{r}
dat %>%
    group_by(Q1.1, Q17.3) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit() %>%
    border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```

### You stated that the software project that you spend the most time working on or with has a code of conduct.  In the box below, please provide a link to that code of conduct.

```{r Q17_4}
dat = dat_na %>%
    filter(Q1.1 == "Combination" & !is.na(Q17.4) | Q1.1 == "Developers" & !is.na(Q17.4)) %>%
    select(Q1.1, Q17.4)



datatable(dat, rownames = FALSE)
```

### Which of the following inclusive practices and policies do you need support in creating for projects that focus on or include software development? Please mark all that apply.

```{r fig21}
dat = dat_na %>%
    filter(!is.na(Q1.1) & !is.na(Q17.5)) %>%
    select(Q1.1, Q17.5)


dat$`Recruiting diverse participants` = ifelse(str_detect(dat$Q17.5, 'Recruiting diverse participants')==T, 'Included', 'Not')
dat$`Retaining diverse participants` = ifelse(str_detect(dat$Q17.5, 'Retaining diverse participants')==T, 'Included', 'Not')
dat$`Including diverse participants in governance and leadership positions` = ifelse(str_detect(dat$Q17.5, 'Including diverse participants in governance and leadership positions')==T, 'Included', 'Not')
dat$`Developing a code of conduct` = ifelse(str_detect(dat$Q17.5, 'Developing a code of conduct')==T, 'Included', 'Not')
dat$`Developing a diversity / inclusivity policy` = ifelse(str_detect(dat$Q17.5, 'Developing a diversity / inclusivity policy')==T, 'Included', 'Not')

datm = reshape2::melt(dat[,-2], id.vars='Q1.1', value.name='Included', variable.name='Practice')

datmm = datm %>%
        filter(Included=='Included')

ggplot(datmm, aes(x= Practice, fill = Q1.1)) +
    geom_bar() +
    labs(x = '', y = 'Frequency') + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.position = 'bottom',
          legend.title = element_blank()) +
    scale_x_discrete(labels = c('Recruiting\n diverse participants', 'Retaining\n diverse participants',
                                'Including diverse participants\n in governance and leadership positions',
                                'Developing a code\n of conduct',
                                'Developing a diversity/\n inclusivity policy'))


ggplot(datmm, aes(x= Practice, fill = Q1.1)) +
    geom_bar(position='fill') + 
    labs(x = '', y = 'Proportion') +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          legend.title = element_blank(),
          legend.position = 'bottom')  +
    scale_x_discrete(labels = c('Recruiting\n diverse participants', 'Retaining\n diverse participants',
                                'Including diverse participants\n in governance and leadership positions',
                                'Developing a code\n of conduct',
                                'Developing a diversity/\n inclusivity policy'))
```

```{r}
datmm %>%
    group_by(Q1.1, Practice) %>%
    tally() %>%
    left_join(tmp3, by = "Q1.1") %>%
    mutate(n = n.x,
           Proportion = percent(n.x/n.y)) %>%
    select(-c(n.x, n.y)) %>%
    flextable() %>%
    merge_v(j = ~ Q1.1) %>%
    autofit()%>%
    border_inner_h(border = officer::fp_border(color = "black", width = 1), part = "body" ) %>%
    fix_border_issues()
```